<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Jesse Mu">
<title>Chapter 8: Group comparisons and hierarchical modeling – Hoff Bayesian Statistics</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-68c8bffd90dad8f2b55c52d7b6410dc0.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-68c8bffd90dad8f2b55c52d7b6410dc0.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-68c8bffd90dad8f2b55c52d7b6410dc0.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-26500bfc55c7891837a911d6d50a6255.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-0358071c7a347cfe579aff309456bf3c.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-26500bfc55c7891837a911d6d50a6255.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script type="application/json" class="js-hypothesis-config">
{
  "theme": "clean",
  "openSidebar": false,
  "enableExperimentalNewNoteButton": true
}
</script><script async="" src="https://hypothes.is/embed.js"></script><script>
  window.document.addEventListener("DOMContentLoaded", function (_event) {
    document.body.classList.add('hypothesis-enabled');
  });
</script><link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script><link rel="stylesheet" href="styles.css">
</head>
<body class="nav-fixed quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Hoff Bayesian Statistics</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-chapters" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Chapters</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-chapters">
<li>
    <a class="dropdown-item" href="./1.html">
 <span class="dropdown-text">Chapter 1: Introduction and examples</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./2.html">
 <span class="dropdown-text">Chapter 2: Belief, probability, and exchangeability</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./3.html">
 <span class="dropdown-text">Chapter 3: One-parameter models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./4.html">
 <span class="dropdown-text">Chapter 4: Monte Carlo approximation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./5.html">
 <span class="dropdown-text">Chapter 5: The Normal Model</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./6.html">
 <span class="dropdown-text">Chapter 6: Posterior approximation with the Gibbs sampler</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./7.html">
 <span class="dropdown-text">Chapter 7: The multivariate normal model</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./8.html">
 <span class="dropdown-text">Chapter 8: Group comparisons and hierarchical modeling</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./9.html">
 <span class="dropdown-text">Chapter 9: Linear regression</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./10.html">
 <span class="dropdown-text">Chapter 10: Nonconjugate priors and Metropolis-Hastings algorithms</span></a>
  </li>  
    </ul>
</li>
  <li class="nav-item">
    <a class="nav-link" href="./irm.html"> 
<span class="menu-text">Infinite Relational Model</span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li>
<a href="#comparing-two-groups" id="toc-comparing-two-groups" class="nav-link active" data-scroll-target="#comparing-two-groups"><span class="header-section-number">1</span> Comparing two groups</a>
  <ul class="collapse">
<li>
<a href="#prior-and-posterior-distributions" id="toc-prior-and-posterior-distributions" class="nav-link" data-scroll-target="#prior-and-posterior-distributions"><span class="header-section-number">1.1</span> Prior and posterior distributions</a>
  <ul class="collapse">
<li><a href="#prior" id="toc-prior" class="nav-link" data-scroll-target="#prior"><span class="header-section-number">1.1.1</span> Prior</a></li>
  <li><a href="#posterior" id="toc-posterior" class="nav-link" data-scroll-target="#posterior"><span class="header-section-number">1.1.2</span> Posterior</a></li>
  </ul>
</li>
  <li><a href="#analysis-of-the-math-score-data" id="toc-analysis-of-the-math-score-data" class="nav-link" data-scroll-target="#analysis-of-the-math-score-data"><span class="header-section-number">1.2</span> Analysis of the math score data</a></li>
  </ul>
</li>
  <li>
<a href="#comparing-multiple-groups" id="toc-comparing-multiple-groups" class="nav-link" data-scroll-target="#comparing-multiple-groups"><span class="header-section-number">2</span> Comparing multiple groups</a>
  <ul class="collapse">
<li><a href="#exchangeability-and-hierarchical-models" id="toc-exchangeability-and-hierarchical-models" class="nav-link" data-scroll-target="#exchangeability-and-hierarchical-models"><span class="header-section-number">2.1</span> Exchangeability and hierarchical models</a></li>
  </ul>
</li>
  <li>
<a href="#the-hierarchical-normal-model" id="toc-the-hierarchical-normal-model" class="nav-link" data-scroll-target="#the-hierarchical-normal-model"><span class="header-section-number">3</span> The hierarchical normal model</a>
  <ul class="collapse">
<li>
<a href="#posterior-inference" id="toc-posterior-inference" class="nav-link" data-scroll-target="#posterior-inference"><span class="header-section-number">3.1</span> Posterior inference</a>
  <ul class="collapse">
<li><a href="#intuition" id="toc-intuition" class="nav-link" data-scroll-target="#intuition"><span class="header-section-number">3.1.1</span> Intuition</a></li>
  <li><a href="#quantities" id="toc-quantities" class="nav-link" data-scroll-target="#quantities"><span class="header-section-number">3.1.2</span> Quantities</a></li>
  </ul>
</li>
  </ul>
</li>
  <li>
<a href="#example-math-scores-in-u.s.-public-schools" id="toc-example-math-scores-in-u.s.-public-schools" class="nav-link" data-scroll-target="#example-math-scores-in-u.s.-public-schools"><span class="header-section-number">4</span> Example: Math scores in U.S. public schools</a>
  <ul class="collapse">
<li>
<a href="#prior-distributions-and-posterior-approximation" id="toc-prior-distributions-and-posterior-approximation" class="nav-link" data-scroll-target="#prior-distributions-and-posterior-approximation"><span class="header-section-number">4.1</span> Prior distributions and posterior approximation</a>
  <ul class="collapse">
<li><a href="#gibbs-sampling" id="toc-gibbs-sampling" class="nav-link" data-scroll-target="#gibbs-sampling"><span class="header-section-number">4.1.1</span> Gibbs sampling</a></li>
  <li><a href="#mcmc-diagnostics" id="toc-mcmc-diagnostics" class="nav-link" data-scroll-target="#mcmc-diagnostics"><span class="header-section-number">4.1.2</span> MCMC diagnostics</a></li>
  </ul>
</li>
  <li><a href="#posterior-summaries-and-shrinkage" id="toc-posterior-summaries-and-shrinkage" class="nav-link" data-scroll-target="#posterior-summaries-and-shrinkage"><span class="header-section-number">4.2</span> Posterior summaries and shrinkage</a></li>
  </ul>
</li>
  <li>
<a href="#hierarchical-modeling-of-means-and-variances" id="toc-hierarchical-modeling-of-means-and-variances" class="nav-link" data-scroll-target="#hierarchical-modeling-of-means-and-variances"><span class="header-section-number">5</span> Hierarchical modeling of means and variances</a>
  <ul class="collapse">
<li><a href="#analysis-of-math-score-data" id="toc-analysis-of-math-score-data" class="nav-link" data-scroll-target="#analysis-of-math-score-data"><span class="header-section-number">5.1</span> Analysis of math score data</a></li>
  </ul>
</li>
  <li>
<a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"><span class="header-section-number">6</span> Exercises</a>
  <ul class="collapse">
<li>
<a href="#section" id="toc-section" class="nav-link" data-scroll-target="#section"><span class="header-section-number">6.1</span> 8.1</a>
  <ul class="collapse">
<li><a href="#a" id="toc-a" class="nav-link" data-scroll-target="#a"><span class="header-section-number">6.1.1</span> a</a></li>
  <li><a href="#b" id="toc-b" class="nav-link" data-scroll-target="#b"><span class="header-section-number">6.1.2</span> b</a></li>
  <li><a href="#c" id="toc-c" class="nav-link" data-scroll-target="#c"><span class="header-section-number">6.1.3</span> c</a></li>
  <li><a href="#d" id="toc-d" class="nav-link" data-scroll-target="#d"><span class="header-section-number">6.1.4</span> d</a></li>
  </ul>
</li>
  <li>
<a href="#section-1" id="toc-section-1" class="nav-link" data-scroll-target="#section-1"><span class="header-section-number">6.2</span> 8.3</a>
  <ul class="collapse">
<li><a href="#a-1" id="toc-a-1" class="nav-link" data-scroll-target="#a-1"><span class="header-section-number">6.2.1</span> a</a></li>
  <li><a href="#b-1" id="toc-b-1" class="nav-link" data-scroll-target="#b-1"><span class="header-section-number">6.2.2</span> b</a></li>
  <li><a href="#c-1" id="toc-c-1" class="nav-link" data-scroll-target="#c-1"><span class="header-section-number">6.2.3</span> c</a></li>
  <li><a href="#d-1" id="toc-d-1" class="nav-link" data-scroll-target="#d-1"><span class="header-section-number">6.2.4</span> d</a></li>
  <li><a href="#e" id="toc-e" class="nav-link" data-scroll-target="#e"><span class="header-section-number">6.2.5</span> e</a></li>
  </ul>
</li>
  </ul>
</li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/d-morrison/hoff-bayesian-statistics/edit/main/8.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/d-morrison/hoff-bayesian-statistics/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li><li><a href="https://github.com/d-morrison/hoff-bayesian-statistics/blob/main/8.qmd" class="toc-action"><i class="bi empty"></i>View source</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Chapter 8: Group comparisons and hierarchical modeling</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Jesse Mu </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">Last modified: 2016-11-17: 0:00:00 (UTC)</p>
    </div>
  </div>
  
    
  </div>
  


</header><!-- Setup --><!-- Begin writing --><p>A common task in data analysis is to compare summary statistics for two or more groups. In this chapter we cover the Bayesian approach to doing this.</p>
<section id="comparing-two-groups" class="level1" data-number="1"><h1 data-number="1">
<span class="header-section-number">1</span> Comparing two groups</h1>
<p>A standard method in (frequentist) introductory statistics for comparing the means of two populations is to compute the <span class="math inline">\(t\)</span>-statistic of the observed mean difference and obtain the two-sided <span class="math inline">\(p\)</span>-value. Then, if <span class="math inline">\(p &lt; 0.05\)</span> (or any other significance level), we reject the null hypothesis that the two groups have the same mean, and use the estimates <span class="math inline">\(\hat{\theta}_1 = \bar{y}_1\)</span> and <span class="math inline">\(\hat{\theta}_2 = \bar{y}_2\)</span> (i.e.&nbsp;the ML estimators for <span class="math inline">\(\theta_1\)</span> and <span class="math inline">\(\theta_2\)</span> independently). Otherwise, we accept the null hypothesis that the two groups have the same mean and let <span class="math inline">\(\hat{\theta}_1 = \hat{\theta}_2\)</span> be the pooled mean of the two groups.</p>
<p>There are many situations in which this paradigm doesn’t make too much sense. Consider borderline cases in which our <span class="math inline">\(p\)</span>-value is close to 0.05. It seems like a technicality to treat the means as completely different if e.g.&nbsp;<span class="math inline">\(p = 0.051\)</span>, and completely the same if <span class="math inline">\(p = 0.049\)</span> - a difference that could hypothetically be observed by simply sampling one more data point.</p>
<p>The Bayesian approach is to treat the two populations as being sampled from a common mean <span class="math inline">\(\theta\)</span> plus some difference <span class="math inline">\(\delta\)</span>, where we estimate both <span class="math inline">\(\theta\)</span> and <span class="math inline">\(\delta\)</span>. Then the observed difference <span class="math inline">\(\delta\)</span> can vary continuously. Specifically, our sampling model for a value from either group is</p>
<ul>
<li><span class="math inline">\(Y_{i, 1} = \mu + \delta + \epsilon_{i, 1}\)</span></li>
<li><span class="math inline">\(Y_{i, 2} = \mu + \delta + \epsilon_{i, 2}\)</span></li>
</ul>
<p>where we assume values from both groups have a common variance <span class="math inline">\(\epsilon_{i, j} \sim \text{i.i.d.}\; \mathcal{N}(0, \sigma^2)\)</span>.</p>
<section id="prior-and-posterior-distributions" class="level2" data-number="1.1"><h2 data-number="1.1" class="anchored" data-anchor-id="prior-and-posterior-distributions">
<span class="header-section-number">1.1</span> Prior and posterior distributions</h2>
<section id="prior" class="level3" data-number="1.1.1"><h3 data-number="1.1.1" class="anchored" data-anchor-id="prior">
<span class="header-section-number">1.1.1</span> Prior</h3>
<p>The joint prior for all three parameters of our model <span class="math inline">\(\mu, \delta, \sigma^2\)</span> is unsurprising. We treat the parameters as independent, so <span class="math inline">\(p(\mu, \delta, \sigma^2) = p(\mu) p(\delta) p(\sigma^2)\)</span> where</p>
<ul>
<li><span class="math inline">\(\mu \sim \mathcal{N}(\mu_0, \gamma_0^2)\)</span></li>
<li><span class="math inline">\(\delta \sim \mathcal{N}(\delta_0, \tau_0^2)\)</span></li>
<li><span class="math inline">\(\sigma^2 \sim \text{inverse-gamma}(\nu_0 / 2, \sigma_0^2 \nu_0 / 2)\)</span></li>
</ul>
<p>Notice that we specify prior distributions for the common mean and variance, but we also express an estimate (and certainty of the estimate) for the difference between the group means <span class="math inline">\(\delta\)</span>.</p>
</section><section id="posterior" class="level3" data-number="1.1.2"><h3 data-number="1.1.2" class="anchored" data-anchor-id="posterior">
<span class="header-section-number">1.1.2</span> Posterior</h3>
<p>Then the full conditional distributions of the parameters are</p>
<ul>
<li>
<span class="math inline">\(\mu \mid \boldsymbol{y}_1, \boldsymbol{y}_2, \delta, \sigma^2 \sim \mathcal{N}(\mu_n, \gamma_n^2)\)</span>
<ul>
<li><span class="math inline">\(\mu_n = \gamma_n^2 \times \left[ \mu_0 / \gamma_0^2 + \sum_{i = 1}^{n_1} (y_{i, 1} - \delta) / \sigma^2 + \sum_{i = 1}^{n_2}(y_{i, 2} + \delta) / \sigma^2 \right]\)</span></li>
<li><span class="math inline">\(\gamma_n^2 = \left[ 1/\gamma_0^2 + (n_1 + n_2) / \sigma^2  \right]^{-1}\)</span></li>
</ul>
</li>
<li>
<span class="math inline">\(\delta \mid \boldsymbol{y}_1, \boldsymbol{y}_2, \mu, \sigma^2 \sim \mathcal{N}(\delta_n, \tau_n^2)\)</span>
<ul>
<li><span class="math inline">\(\delta_n = \tau_n^2 \times \left[ \delta_0 / \tau_0^2 + \sum_{i = 1}^{n_1} (y_{i, 1} - \mu) / \sigma^2 - \sum_{i = 1}^{n_2} (y_{i, 2} - \mu) / \sigma^2 \right]\)</span></li>
<li><span class="math inline">\(\tau_n^2 = \left[ 1 / \tau_0^2 + (n_1 + n_2) / \sigma^2 \right]^{-1}\)</span></li>
</ul>
</li>
<li>
<span class="math inline">\(\sigma^2 \mid \boldsymbol{y}_1, \boldsymbol{y}_2, \mu, \delta \sim \text{inverse-gamma}(\nu_n / 2, \sigma_n^2 \nu_n / 2)\)</span>
<ul>
<li><span class="math inline">\(\nu_n = \nu_0 + n_1 + n_2\)</span></li>
<li><span class="math inline">\(\nu_n \sigma_n^2 = \nu_0 \sigma_0^2 + \sum_{i = 1}^{n_1} (y_{i, 1} - \left[\mu + \delta \right])^2 + \sum_{i = 1}^{n_2} (y_{i, 2} - \left[ \mu - \delta \right])^2\)</span></li>
</ul>
</li>
</ul></section></section><section id="analysis-of-the-math-score-data" class="level2" data-number="1.2"><h2 data-number="1.2" class="anchored" data-anchor-id="analysis-of-the-math-score-data">
<span class="header-section-number">1.2</span> Analysis of the math score data</h2>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Show R code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">'Replication/chapter8.R'</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="8_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="8_files/figure-html/unnamed-chunk-2-2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="8_files/figure-html/unnamed-chunk-2-3.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-4.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="8_files/figure-html/unnamed-chunk-2-4.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-5.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="8_files/figure-html/unnamed-chunk-2-5.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-6.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="8_files/figure-html/unnamed-chunk-2-6.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-7.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="8_files/figure-html/unnamed-chunk-2-7.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-8.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="8_files/figure-html/unnamed-chunk-2-8.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-9.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9"><img src="8_files/figure-html/unnamed-chunk-2-9.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-10.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10"><img src="8_files/figure-html/unnamed-chunk-2-10.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-11.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11"><img src="8_files/figure-html/unnamed-chunk-2-11.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-12.png" class="lightbox" data-gallery="quarto-lightbox-gallery-12"><img src="8_files/figure-html/unnamed-chunk-2-12.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-13.png" class="lightbox" data-gallery="quarto-lightbox-gallery-13"><img src="8_files/figure-html/unnamed-chunk-2-13.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-14.png" class="lightbox" data-gallery="quarto-lightbox-gallery-14"><img src="8_files/figure-html/unnamed-chunk-2-14.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-15.png" class="lightbox" data-gallery="quarto-lightbox-gallery-15"><img src="8_files/figure-html/unnamed-chunk-2-15.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-16.png" class="lightbox" data-gallery="quarto-lightbox-gallery-16"><img src="8_files/figure-html/unnamed-chunk-2-16.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-17.png" class="lightbox" data-gallery="quarto-lightbox-gallery-17"><img src="8_files/figure-html/unnamed-chunk-2-17.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-18.png" class="lightbox" data-gallery="quarto-lightbox-gallery-18"><img src="8_files/figure-html/unnamed-chunk-2-18.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-19.png" class="lightbox" data-gallery="quarto-lightbox-gallery-19"><img src="8_files/figure-html/unnamed-chunk-2-19.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-20.png" class="lightbox" data-gallery="quarto-lightbox-gallery-20"><img src="8_files/figure-html/unnamed-chunk-2-20.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-21.png" class="lightbox" data-gallery="quarto-lightbox-gallery-21"><img src="8_files/figure-html/unnamed-chunk-2-21.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-22.png" class="lightbox" data-gallery="quarto-lightbox-gallery-22"><img src="8_files/figure-html/unnamed-chunk-2-22.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-23.png" class="lightbox" data-gallery="quarto-lightbox-gallery-23"><img src="8_files/figure-html/unnamed-chunk-2-23.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-24.png" class="lightbox" data-gallery="quarto-lightbox-gallery-24"><img src="8_files/figure-html/unnamed-chunk-2-24.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-25.png" class="lightbox" data-gallery="quarto-lightbox-gallery-25"><img src="8_files/figure-html/unnamed-chunk-2-25.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-26.png" class="lightbox" data-gallery="quarto-lightbox-gallery-26"><img src="8_files/figure-html/unnamed-chunk-2-26.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-27.png" class="lightbox" data-gallery="quarto-lightbox-gallery-27"><img src="8_files/figure-html/unnamed-chunk-2-27.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-28.png" class="lightbox" data-gallery="quarto-lightbox-gallery-28"><img src="8_files/figure-html/unnamed-chunk-2-28.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-29.png" class="lightbox" data-gallery="quarto-lightbox-gallery-29"><img src="8_files/figure-html/unnamed-chunk-2-29.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-30.png" class="lightbox" data-gallery="quarto-lightbox-gallery-30"><img src="8_files/figure-html/unnamed-chunk-2-30.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-31.png" class="lightbox" data-gallery="quarto-lightbox-gallery-31"><img src="8_files/figure-html/unnamed-chunk-2-31.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-32.png" class="lightbox" data-gallery="quarto-lightbox-gallery-32"><img src="8_files/figure-html/unnamed-chunk-2-32.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-33.png" class="lightbox" data-gallery="quarto-lightbox-gallery-33"><img src="8_files/figure-html/unnamed-chunk-2-33.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-34.png" class="lightbox" data-gallery="quarto-lightbox-gallery-34"><img src="8_files/figure-html/unnamed-chunk-2-34.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-35.png" class="lightbox" data-gallery="quarto-lightbox-gallery-35"><img src="8_files/figure-html/unnamed-chunk-2-35.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-36.png" class="lightbox" data-gallery="quarto-lightbox-gallery-36"><img src="8_files/figure-html/unnamed-chunk-2-36.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-37.png" class="lightbox" data-gallery="quarto-lightbox-gallery-37"><img src="8_files/figure-html/unnamed-chunk-2-37.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-38.png" class="lightbox" data-gallery="quarto-lightbox-gallery-38"><img src="8_files/figure-html/unnamed-chunk-2-38.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-39.png" class="lightbox" data-gallery="quarto-lightbox-gallery-39"><img src="8_files/figure-html/unnamed-chunk-2-39.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-40.png" class="lightbox" data-gallery="quarto-lightbox-gallery-40"><img src="8_files/figure-html/unnamed-chunk-2-40.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-41.png" class="lightbox" data-gallery="quarto-lightbox-gallery-41"><img src="8_files/figure-html/unnamed-chunk-2-41.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-42.png" class="lightbox" data-gallery="quarto-lightbox-gallery-42"><img src="8_files/figure-html/unnamed-chunk-2-42.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-43.png" class="lightbox" data-gallery="quarto-lightbox-gallery-43"><img src="8_files/figure-html/unnamed-chunk-2-43.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-44.png" class="lightbox" data-gallery="quarto-lightbox-gallery-44"><img src="8_files/figure-html/unnamed-chunk-2-44.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-45.png" class="lightbox" data-gallery="quarto-lightbox-gallery-45"><img src="8_files/figure-html/unnamed-chunk-2-45.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-46.png" class="lightbox" data-gallery="quarto-lightbox-gallery-46"><img src="8_files/figure-html/unnamed-chunk-2-46.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-47.png" class="lightbox" data-gallery="quarto-lightbox-gallery-47"><img src="8_files/figure-html/unnamed-chunk-2-47.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-48.png" class="lightbox" data-gallery="quarto-lightbox-gallery-48"><img src="8_files/figure-html/unnamed-chunk-2-48.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-49.png" class="lightbox" data-gallery="quarto-lightbox-gallery-49"><img src="8_files/figure-html/unnamed-chunk-2-49.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-50.png" class="lightbox" data-gallery="quarto-lightbox-gallery-50"><img src="8_files/figure-html/unnamed-chunk-2-50.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-51.png" class="lightbox" data-gallery="quarto-lightbox-gallery-51"><img src="8_files/figure-html/unnamed-chunk-2-51.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-52.png" class="lightbox" data-gallery="quarto-lightbox-gallery-52"><img src="8_files/figure-html/unnamed-chunk-2-52.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-53.png" class="lightbox" data-gallery="quarto-lightbox-gallery-53"><img src="8_files/figure-html/unnamed-chunk-2-53.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-54.png" class="lightbox" data-gallery="quarto-lightbox-gallery-54"><img src="8_files/figure-html/unnamed-chunk-2-54.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-55.png" class="lightbox" data-gallery="quarto-lightbox-gallery-55"><img src="8_files/figure-html/unnamed-chunk-2-55.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-56.png" class="lightbox" data-gallery="quarto-lightbox-gallery-56"><img src="8_files/figure-html/unnamed-chunk-2-56.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-57.png" class="lightbox" data-gallery="quarto-lightbox-gallery-57"><img src="8_files/figure-html/unnamed-chunk-2-57.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-58.png" class="lightbox" data-gallery="quarto-lightbox-gallery-58"><img src="8_files/figure-html/unnamed-chunk-2-58.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-59.png" class="lightbox" data-gallery="quarto-lightbox-gallery-59"><img src="8_files/figure-html/unnamed-chunk-2-59.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-60.png" class="lightbox" data-gallery="quarto-lightbox-gallery-60"><img src="8_files/figure-html/unnamed-chunk-2-60.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-61.png" class="lightbox" data-gallery="quarto-lightbox-gallery-61"><img src="8_files/figure-html/unnamed-chunk-2-61.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-62.png" class="lightbox" data-gallery="quarto-lightbox-gallery-62"><img src="8_files/figure-html/unnamed-chunk-2-62.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-63.png" class="lightbox" data-gallery="quarto-lightbox-gallery-63"><img src="8_files/figure-html/unnamed-chunk-2-63.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-64.png" class="lightbox" data-gallery="quarto-lightbox-gallery-64"><img src="8_files/figure-html/unnamed-chunk-2-64.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-65.png" class="lightbox" data-gallery="quarto-lightbox-gallery-65"><img src="8_files/figure-html/unnamed-chunk-2-65.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-66.png" class="lightbox" data-gallery="quarto-lightbox-gallery-66"><img src="8_files/figure-html/unnamed-chunk-2-66.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-67.png" class="lightbox" data-gallery="quarto-lightbox-gallery-67"><img src="8_files/figure-html/unnamed-chunk-2-67.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-68.png" class="lightbox" data-gallery="quarto-lightbox-gallery-68"><img src="8_files/figure-html/unnamed-chunk-2-68.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-69.png" class="lightbox" data-gallery="quarto-lightbox-gallery-69"><img src="8_files/figure-html/unnamed-chunk-2-69.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-70.png" class="lightbox" data-gallery="quarto-lightbox-gallery-70"><img src="8_files/figure-html/unnamed-chunk-2-70.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-71.png" class="lightbox" data-gallery="quarto-lightbox-gallery-71"><img src="8_files/figure-html/unnamed-chunk-2-71.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<details class="code-fold"><summary>Show R code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">y1</span> <span class="op">=</span> <span class="va">y.school1</span></span>
<span><span class="va">y2</span> <span class="op">=</span> <span class="va">y.school2</span></span>
<span><span class="va">n1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">y1</span><span class="op">)</span></span>
<span><span class="va">n2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">y2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Priors</span></span>
<span><span class="va">mu0</span> <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="va">g20</span> <span class="op">=</span> <span class="fl">625</span></span>
<span><span class="va">del0</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="va">t20</span> <span class="op">=</span> <span class="fl">625</span></span>
<span><span class="va">s20</span> <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="va">nu0</span> <span class="op">=</span> <span class="fl">1</span></span>
<span></span>
<span><span class="co"># starting values based on ML estimates</span></span>
<span><span class="va">mu</span> <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">y1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">y2</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span></span>
<span><span class="va">del</span> <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">y1</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">y2</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span></span>
<span></span>
<span><span class="co"># Gibbs sampler</span></span>
<span><span class="va">S</span> <span class="op">=</span> <span class="fl">5000</span></span>
<span><span class="va">MU</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">S</span><span class="op">)</span></span>
<span><span class="va">DEL</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">S</span><span class="op">)</span></span>
<span><span class="va">S2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">S</span><span class="op">)</span></span>
<span><span class="va">Y12</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="va">S</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">S</span><span class="op">)</span>  <span class="op">{</span></span>
<span></span>
<span>  <span class="co"># Sample s2 according to p.128 eq 3</span></span>
<span>  <span class="va">s2</span> <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html">rgamma</a></span><span class="op">(</span><span class="fl">1</span>, <span class="op">(</span><span class="va">nu0</span> <span class="op">+</span> <span class="va">n1</span> <span class="op">+</span> <span class="va">n2</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span>,</span>
<span>                  <span class="op">(</span><span class="va">nu0</span> <span class="op">*</span> <span class="va">s20</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">y1</span> <span class="op">-</span> <span class="va">mu</span> <span class="op">-</span> <span class="va">del</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">y2</span> <span class="op">-</span> <span class="va">mu</span> <span class="op">+</span> <span class="va">del</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Sample mu according to p.128 eq 1</span></span>
<span>  <span class="va">var.mu</span> <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="va">g20</span> <span class="op">+</span> <span class="op">(</span><span class="va">n1</span> <span class="op">+</span> <span class="va">n2</span><span class="op">)</span> <span class="op">/</span> <span class="va">s2</span><span class="op">)</span></span>
<span>  <span class="va">mean.mu</span> <span class="op">=</span> <span class="va">var.mu</span> <span class="op">*</span> <span class="op">(</span><span class="va">mu0</span><span class="op">/</span><span class="va">g20</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">y1</span> <span class="op">-</span> <span class="va">del</span><span class="op">)</span> <span class="op">/</span> <span class="va">s2</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">y2</span> <span class="op">+</span> <span class="va">del</span><span class="op">)</span> <span class="op">/</span> <span class="va">s2</span><span class="op">)</span></span>
<span>  <span class="va">mu</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mean.mu</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">var.mu</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Sample del according to p.128 eq 2</span></span>
<span>  <span class="va">var.del</span> <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="va">t20</span> <span class="op">+</span> <span class="op">(</span><span class="va">n1</span> <span class="op">+</span> <span class="va">n2</span><span class="op">)</span> <span class="op">/</span> <span class="va">s2</span> <span class="op">)</span></span>
<span>  <span class="va">mean.del</span> <span class="op">=</span> <span class="va">var.del</span> <span class="op">*</span> <span class="op">(</span><span class="va">del0</span> <span class="op">/</span> <span class="va">t20</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">y1</span> <span class="op">-</span> <span class="va">mu</span><span class="op">)</span> <span class="op">/</span> <span class="va">s2</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">y2</span> <span class="op">-</span> <span class="va">mu</span><span class="op">)</span> <span class="op">/</span> <span class="va">s2</span><span class="op">)</span></span>
<span>  <span class="va">del</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mean.del</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">var.del</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Store params</span></span>
<span>  <span class="va">MU</span><span class="op">[</span><span class="va">s</span><span class="op">]</span> <span class="op">=</span> <span class="va">mu</span></span>
<span>  <span class="va">DEL</span><span class="op">[</span><span class="va">s</span><span class="op">]</span> <span class="op">=</span> <span class="va">del</span></span>
<span>  <span class="va">S2</span><span class="op">[</span><span class="va">s</span><span class="op">]</span> <span class="op">=</span> <span class="va">s2</span></span>
<span>  <span class="co"># Sample from posterior</span></span>
<span>  <span class="va">Y12</span><span class="op">[</span><span class="va">s</span>, <span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">2</span>, <span class="va">mu</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">del</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">s2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span>                 </span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>mu <span class="op">=</span> <span class="va">MU</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_density</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">mu</span><span class="op">)</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-2-72.png" class="lightbox" data-gallery="quarto-lightbox-gallery-72"><img src="8_files/figure-html/unnamed-chunk-2-72.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
<p>Now we can directly estimate the probability that <span class="math inline">\(\delta &gt; 0\)</span>:</p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Show R code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">DEL</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.95</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>as well as the probability that an individual from school 1 is higher than school 2, which due to variance is a bit lower:</p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Show R code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y12</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&gt;</span> <span class="va">Y12</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.6232</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section></section><section id="comparing-multiple-groups" class="level1" data-number="2"><h1 data-number="2">
<span class="header-section-number">2</span> Comparing multiple groups</h1>
<p>Let’s extend this to a <span class="math inline">\(&gt; 2\)</span> group case. Assume for our example above that we have many schools, which we assume are samples from a populatio of schools. So our dataset is <em>hierarchical</em> or <em>multilevel</em> since there are samples of schools and within each school samples of students.</p>
<section id="exchangeability-and-hierarchical-models" class="level2" data-number="2.1"><h2 data-number="2.1" class="anchored" data-anchor-id="exchangeability-and-hierarchical-models">
<span class="header-section-number">2.1</span> Exchangeability and hierarchical models</h2>
<p>Using de Finetti’s theorem and assuming exchangability, we knew previously that for a single group, we can treat the data within the group as being conditionally i.i.d. given a parameter, which we call the <strong>within-group sampling variability</strong>:</p>
<p><span class="math display">\[
\{Y_{1, j}, \dots, Y_{n_{j}, j} \mid \phi_j\} \sim \text{i.i.d.}\; p(y \mid \phi_j)
\]</span></p>
<p>Further, if we have many groups with parameters <span class="math inline">\(\phi_j\)</span> that we assume are sampled from a population of <em>groups</em> we can again use de Finetti’s theorem to treat the group means <span class="math inline">\(\phi_j\)</span> as conditionally i.i.d. given another parameter, which we call the <strong>between-group sampling variability</strong>:</p>
<p><span class="math display">\[
\{\phi_{1}, \dots, \phi_{m} \mid \psi\} \sim \text{i.i.d.} \; p(\phi \mid \psi)
\]</span></p>
<p>Then we simply need a prior distribution on the parameter for the group parameters (a “hyperparameter”) <span class="math inline">\(\psi\)</span>:</p>
<p><span class="math display">\[
\psi \sim p(\psi)
\]</span></p>
<p>Note that we can extend this hierarchy arbitrarily.</p>
</section></section><section id="the-hierarchical-normal-model" class="level1" data-number="3"><h1 data-number="3">
<span class="header-section-number">3</span> The hierarchical normal model</h1>
<p>The key of the hierarchical normal model is to treat the data within a group as being normally distributed with some mean <span class="math inline">\(\theta_j\)</span> and variance <span class="math inline">\(\sigma^2\)</span>, and the means among groups to <em>also</em> be normally distributed according to some other mean <span class="math inline">\(\mu\)</span> and variance <span class="math inline">\(\tau^2\)</span>. Note that for now we’re assuming that the data within groups share a common variance <span class="math inline">\(\sigma^2\)</span> that doesn’t depend on the group <span class="math inline">\(j\)</span>.</p>
<p>Specifically, we have</p>
<ul>
<li><span class="math inline">\(Y_{i, j} \sim \mathcal{N}(\theta_j, \sigma^2)\)</span></li>
<li><span class="math inline">\(\theta_j \sim \mathcal{N}(\mu, \tau^2)\)</span></li>
</ul>
<p>So for <span class="math inline">\(m\)</span> groups, we have unknown parameters <span class="math inline">\(\{\theta_1, \dots, \theta_m\}\)</span>, the within-group variance <span class="math inline">\(\sigma^2\)</span>, and the mean and variance of the group means <span class="math inline">\((\mu, \tau^2)\)</span>. Notice that there are three fixed parameters for which we need to specify prior distributions: <span class="math inline">\(\mu\)</span>, <span class="math inline">\(\tau^2\)</span>, and <span class="math inline">\(\sigma^2\)</span>. Our priors will be standard inverse-gamma and normal semiconjugate priors:</p>
<p><span class="math display">\[\begin{align}
\sigma^2 &amp;\sim \text{inverse-gamma}(\nu_0 / 2, \sigma_0^2 \nu_0 / 2) \\
\tau^2 &amp;\sim \text{inverse-gamma}(\eta_0 / 2, \tau_0^2 \eta_0 / 2) \\
\mu^2 &amp;\sim \mathcal{N}(\mu_0, \gamma_0^2)
\end{align}\]</span></p>
<p><strong>Fig 8.3</strong> isn’t reproduced here in these notes but is important for visualizing the model. It especially helps to know how Bayesian networks are interpreted, which helps explain the conditional dependencies.</p>
<section id="posterior-inference" class="level2" data-number="3.1"><h2 data-number="3.1" class="anchored" data-anchor-id="posterior-inference">
<span class="header-section-number">3.1</span> Posterior inference</h2>
<section id="intuition" class="level3" data-number="3.1.1"><h3 data-number="3.1.1" class="anchored" data-anchor-id="intuition">
<span class="header-section-number">3.1.1</span> Intuition</h3>
<p>We have samples from <span class="math inline">\(m\)</span> groups <span class="math inline">\(\{\boldsymbol{y}_1, \dots, \boldsymbol{y}_m\}\)</span>. Our task is to sample from the posterior distribution</p>
<p><span class="math display">\[
p(\theta_1, \dots, \theta_m, \mu, \tau^2, \sigma^2 \mid \boldsymbol{y}_1, \dots, \boldsymbol{y}_m)
\]</span></p>
<p>for which we’ll use a Gibbs sampler. We need to find the full conditionals for all unknown quantities above, which seems intimidating. In the Chapter 6 notes (“a shortcut for thinking about full conditionals”), however, I mention that obtaining the full conditional for a single parameter is fairly straightforward by simply writing the entire joint posterior but then treating the other parameters as constants that can be discarded via proportionality.</p>
<p>To obtain the full joint posterior we will take use key independence assumptions between the parameters of our model. For example, given a group-specific mean <span class="math inline">\(\theta_j\)</span>, the corresponding random variables <span class="math inline">\(Y_{i, j}\)</span> depend only on <span class="math inline">\((\theta_j, \sigma^2)\)</span> and not on <span class="math inline">\(\mu\)</span> or <span class="math inline">\(\tau^2\)</span> (this is implied in Figure 8.3).</p>
<p><span class="math display">\[\begin{align}
&amp; p(\theta_1, \dots, \theta_m, \mu, \tau^2, \sigma^2 \mid \boldsymbol{y}_1, \dots, \boldsymbol{y}_m) \\
\quad&amp;\propto p(\mu, \tau^2, \sigma^2, \mu, \tau^2, \sigma^2) \times p(\boldsymbol{y}_1, \dots, \boldsymbol{y}_m \mid \theta_1, \dots, \theta_m, \mu, \tau^2, \sigma^2) &amp; \text{Bayes' rule} \\
&amp;= p(\mu, \tau^2, \sigma^2) \times p(\theta_1, \dots, \theta_m \mid \mu, \tau^2, \sigma^2) \times p(\boldsymbol{y}_1, \dots, \boldsymbol{y}_m \mid \theta_1, \dots, \theta_m, \mu, \tau^2, \sigma^2) &amp; \text{Chain rule} \\
&amp;= p(\mu) p(\tau^2) p(\sigma^2) \times p(\theta_1, \dots, \theta_m \mid \mu, \tau^2) \times p(\boldsymbol{y}_1, \dots, \boldsymbol{y}_m \mid \theta_1, \dots, \theta_m, \sigma^2) &amp; \text{Indep.} \\
&amp;= p(\mu) p(\tau^2) p(\sigma^2) \times \left[ \prod_{j = 1}^m p(\theta_j \mid \mu, \tau^2) \right] \times \left[ \prod_{j = 1}^m p(\boldsymbol{y}_j \mid \theta_j, \sigma^2) \right] &amp; \text{de Finetti} \\
&amp;= p(\mu) p(\tau^2) p(\sigma^2) \times \left[ \prod_{j = 1}^m p(\theta_j \mid \mu, \tau^2) \right] \times \left[ \prod_{j = 1}^m \left( \prod_{i = 1}^{n_j} p(y_{i, j} \mid \theta_j, \sigma^2) \right) \right] &amp; \text{de Finetti 2x} \\
\end{align}\]</span></p>
<p>Now to evaluate a full conditional, for example that for <span class="math inline">\(\mu\)</span>, we take the full posterior and discard all terms that don’t depend on <span class="math inline">\(\mu\)</span>:</p>
<p><span class="math display">\[p(\mu \mid \theta_1, \dots, \theta_m, \tau^2, \sigma^2, \boldsymbol{y}_1, \dots, \boldsymbol{y}_m) \propto p(\mu) \prod_{j=1}^m p(\theta_j \mid \mu, \tau^2)\]</span></p>
<p>which in this case looks exactly like a standard one-sample Normal posterior from Chapter 6, so we borrow that result and replace the relevant variables from our priors. We can do this similarly for the other parameters.</p>
</section><section id="quantities" class="level3" data-number="3.1.2"><h3 data-number="3.1.2" class="anchored" data-anchor-id="quantities">
<span class="header-section-number">3.1.2</span> Quantities</h3>
<p>Since the work is quite tedious, I leave out the derivations for the full conditionals of the parameters. To summarize, given priors</p>
<p><span class="math display">\[\begin{align}
\sigma^2 &amp;\sim \text{inverse-gamma}(\nu_0 / 2, \sigma_0^2 \nu_0 / 2) \\
\tau^2 &amp;\sim \text{inverse-gamma}(\eta_0 / 2, \tau_0^2 \eta_0 / 2) \\
\mu^2 &amp;\sim \mathcal{N}(\mu_0, \gamma_0^2)
\end{align}\]</span></p>
<p>the full conditionals are</p>
<p><span class="math display">\[\begin{align}
\{\mu \mid \theta_1, \dots, \theta_m, \tau^2\} &amp;\sim \mathcal{N}\left(\frac{m\bar{\theta} / \tau^2 + \mu_0 / \gamma_0^2}{m/\tau^2 + 1 / \gamma_0^2}, \left[m / \tau^2 + 1 / \gamma_0^2 \right]^{-1}\right) \\
\{\tau^2 \mid \theta_1, \dots, \theta_m, \mu\} &amp;\sim \text{inverse-gamma}\left(\frac{\eta_0 + m}{2}, \frac{\eta_0\tau_0^2 + \sum_{j = 1}^{m}(\theta_j - \mu)^2}{2} \right) \\
\{\theta_j \mid y_{1, j}, \dots, y_{n_{j}, j}, \sigma^2\} &amp;\sim \mathcal{N}\left(\frac{n_j\bar{y}_j / \sigma^2 + 1 / \tau^2}{n_j / \sigma^2 + 1 / \tau^2}, \left[ n_j / \sigma^2 + 1 / \tau^2 \right]^{-1} \right) \\
\{\sigma^2 \mid \boldsymbol{\theta}, \boldsymbol{y_1}, \dots, \boldsymbol{y_n}\} &amp;\sim \text{inverse-gamma}\left(\frac{1}{2}\left[ \nu_0 + \sum_{j = 1}^m n_j\right], \frac{1}{2}\left[\nu_0\sigma_0^2 + \sum_{j = 1}^{m} \left( \sum_{i = 1}^{n_j} (y_{i, j} - \theta)^2 \right) \right] \right)
\end{align}\]</span></p>
<p>It’s worth briefly discussing what these values represent. The full conditionals for <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\tau^2\)</span> look like standard normal posteriors. Similarly, the full conditional for <span class="math inline">\(\theta_j\)</span> looks like a normal posterior dependent only on the specific subgroup <span class="math inline">\(\boldsymbol{y}_j\)</span> and the common variance <span class="math inline">\(\sigma^2\)</span>. Lastly (and most interestingly), notice that the posterior for <span class="math inline">\(\sigma^2\)</span> looks like a standard inverse gamma posterior which depends on <span class="math inline">\(\sum \sum (y_{i, j} -
\theta)^2\)</span> which is the pooled variance across all groups (see also <span class="math inline">\(\sum n_j\)</span>).</p>
</section></section></section><section id="example-math-scores-in-u.s.-public-schools" class="level1" data-number="4"><h1 data-number="4">
<span class="header-section-number">4</span> Example: Math scores in U.S. public schools</h1>
<p>We now look at the full dataset of math scores from 100 schools:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-5-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-73"><img src="8_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
<section id="prior-distributions-and-posterior-approximation" class="level2" data-number="4.1"><h2 data-number="4.1" class="anchored" data-anchor-id="prior-distributions-and-posterior-approximation">
<span class="header-section-number">4.1</span> Prior distributions and posterior approximation</h2>
<p>We need to specify the following priors:</p>
<p><span class="math display">\[
\sigma^2 \sim \text{inverse-gamma}(\nu_0 / 2, \sigma_0^2 \nu_0 / 2)
\]</span></p>
<p>If we know the math exam was designed to give a nationwide variance of 100, we can set the within-school variance to 100. This is probably an overestimate since the within-school variance should be less than the nationwide estimate. Regardless, we set <span class="math inline">\(\sigma_0^2 = 100, \nu_0 = 1\)</span> to weakly concentrate the prior around 100.</p>
<p><span class="math display">\[
\tau^2 \sim \text{inverse-gamma}(\eta_0 / 2, \tau_0^2 \eta_0 / 2)
\]</span></p>
<p>Similarly, we set <span class="math inline">\(\tau_0^2 = 100, \eta_0 = 1\)</span>.</p>
<p><span class="math display">\[
\mu^2 \sim \mathcal{N}(\mu_0, \gamma_0^2)
\]</span></p>
<p>Since the mean over all schools should be 50, we set <span class="math inline">\(\mu_0 = 50, \gamma_0^2 = 25\)</span>, so that 95% of the probability of our prior is in <span class="math inline">\((40, 60)\)</span>.</p>
<section id="gibbs-sampling" class="level3" data-number="4.1.1"><h3 data-number="4.1.1" class="anchored" data-anchor-id="gibbs-sampling">
<span class="header-section-number">4.1.1</span> Gibbs sampling</h3>
<p>Now that we’re sampling more and more parameters <span class="math inline">\(\{\mu^{(s)}, \tau^{2(s)},
\sigma^{2(s)}, \theta_1^{(s)}, \dots, \theta_m^{(s)} \}\)</span>, there’s a key point about Gibbs sampling that must be emphasized: the order in which we sample the new parameters doesn’t matter, but each parameter must be updated according to the <em>most current</em> values of the other parameters. That is, if we have sampled <span class="math inline">\(\mu^{(s+1)}\)</span>, the sample of <span class="math inline">\(\tau^{(s + 1)}\)</span> must be dependent on <span class="math inline">\(\mu^{(s+1)}\)</span>, <strong>NOT</strong> <span class="math inline">\(\mu^{(s)}\)</span>. This ensures the markov chain property.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Show R code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Y</span> <span class="op">=</span> <span class="va">Y.school.mathscore</span></span>
<span></span>
<span><span class="co"># Priors</span></span>
<span><span class="va">nu0</span> <span class="op">=</span> <span class="va">eta0</span> <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="va">s20</span> <span class="op">=</span> <span class="va">t20</span> <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="va">mu0</span> <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="va">g20</span> <span class="op">=</span> <span class="fl">25</span></span>
<span></span>
<span><span class="co"># Number of schools. Y[, 1] are school ids</span></span>
<span><span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">Y</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Starting values - use sample mean and variance</span></span>
<span><span class="va">n</span> <span class="op">=</span> <span class="va">sv</span> <span class="op">=</span> <span class="va">ybar</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">m</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">m</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">Y_j</span> <span class="op">=</span> <span class="va">Y</span><span class="op">[</span><span class="va">Y</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="va">j</span>, <span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="va">ybar</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_j</span><span class="op">)</span></span>
<span>  <span class="va">sv</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">var</a></span><span class="op">(</span><span class="va">Y_j</span><span class="op">)</span></span>
<span>  <span class="va">n</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">Y_j</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># Let initial theta estimates be the sample means</span></span>
<span><span class="co"># Similarly, let initial values of sigma2, mu, and tau2 be "sample mean and</span></span>
<span><span class="co"># variance"</span></span>
<span><span class="va">theta</span> <span class="op">=</span> <span class="va">ybar</span></span>
<span><span class="va">sigma2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">sv</span><span class="op">)</span></span>
<span><span class="va">mu</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span></span>
<span><span class="va">tau2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">var</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># MCMC</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">S</span> <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="va">THETA</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="va">S</span>, ncol <span class="op">=</span> <span class="va">m</span><span class="op">)</span></span>
<span><span class="co"># Storing sigma, mu, theta together</span></span>
<span><span class="va">SMT</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="va">S</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">S</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Sample thetas</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">m</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">vtheta</span> <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="va">n</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">/</span> <span class="va">sigma2</span> <span class="op">+</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">tau2</span><span class="op">)</span></span>
<span>    <span class="va">etheta</span> <span class="op">=</span> <span class="va">vtheta</span> <span class="op">*</span> <span class="op">(</span><span class="va">ybar</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">*</span> <span class="va">n</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">/</span> <span class="va">sigma2</span> <span class="op">+</span> <span class="va">mu</span> <span class="op">/</span> <span class="va">tau2</span><span class="op">)</span></span>
<span>    <span class="va">theta</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">etheta</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">vtheta</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Sample sigma2</span></span>
<span>  <span class="va">nun</span> <span class="op">=</span> <span class="va">nu0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="co"># TODO: Could cache this</span></span>
<span>  <span class="va">ss</span> <span class="op">=</span> <span class="va">nu0</span> <span class="op">*</span> <span class="va">s20</span></span>
<span>  <span class="co"># Pool variance</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">m</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">ss</span> <span class="op">=</span> <span class="va">ss</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">Y</span><span class="op">[</span><span class="va">Y</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="va">j</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">theta</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">sigma2</span> <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html">rgamma</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">nun</span> <span class="op">/</span> <span class="fl">2</span>, <span class="va">ss</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Sample mu</span></span>
<span>  <span class="va">vmu</span> <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="va">m</span> <span class="op">/</span> <span class="va">tau2</span> <span class="op">+</span> <span class="fl">1</span> <span class="op">/</span><span class="va">g20</span><span class="op">)</span></span>
<span>  <span class="va">emu</span> <span class="op">=</span> <span class="va">vmu</span> <span class="op">*</span> <span class="op">(</span><span class="va">m</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span> <span class="op">/</span> <span class="va">tau2</span> <span class="op">+</span> <span class="va">mu0</span> <span class="op">/</span> <span class="va">g20</span><span class="op">)</span></span>
<span>  <span class="va">mu</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">emu</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">vmu</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Sample tau2</span></span>
<span>  <span class="va">etam</span> <span class="op">=</span> <span class="va">eta0</span> <span class="op">+</span> <span class="va">m</span></span>
<span>  <span class="va">ss</span> <span class="op">=</span> <span class="va">eta0</span> <span class="op">*</span> <span class="va">t20</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">theta</span> <span class="op">-</span> <span class="va">mu</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">tau2</span> <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html">rgamma</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">etam</span> <span class="op">/</span> <span class="fl">2</span>, <span class="va">ss</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Store params</span></span>
<span>  <span class="va">THETA</span><span class="op">[</span><span class="va">s</span>, <span class="op">]</span> <span class="op">=</span> <span class="va">theta</span></span>
<span>  <span class="va">SMT</span><span class="op">[</span><span class="va">s</span>, <span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">sigma2</span>, <span class="va">mu</span>, <span class="va">tau2</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section><section id="mcmc-diagnostics" class="level3" data-number="4.1.2"><h3 data-number="4.1.2" class="anchored" data-anchor-id="mcmc-diagnostics">
<span class="header-section-number">4.1.2</span> MCMC diagnostics</h3>
<p>The book mentions here that it’s important to check convergence of the Gibbs sampler; I won’t do that here, but dividing the samples into groups of e.g.&nbsp;500 samples, and ensuring that the mean values of the parameters don’t change too much from group to group is a good way to check, at least for a manageable number of parameters.</p>
</section></section><section id="posterior-summaries-and-shrinkage" class="level2" data-number="4.2"><h2 data-number="4.2" class="anchored" data-anchor-id="posterior-summaries-and-shrinkage">
<span class="header-section-number">4.2</span> Posterior summaries and shrinkage</h2>
<p>Notice from the full conditional of <span class="math inline">\(\theta_j\)</span> above that the expected value of <span class="math inline">\(\theta_j\)</span> is a weighted average of <span class="math inline">\(\bar{y}_j\)</span> and <span class="math inline">\(\mu\)</span>:</p>
<p><span class="math display">\[\begin{align}
\mathbb{E}(\theta_j \mid \boldsymbol{y}_j, \mu, \tau^2, \sigma^2) &amp;= \frac{\bar{y}_j n_j / \sigma^2 + \mu/\tau^2}{n_j / \sigma^2 + 1 / \tau^2} \\
&amp;= \frac{n_j / \sigma^2}{n_j / \sigma^2 + 1 / \tau^2} \bar{y}_j + \frac{1 / \tau^2}{n_j / \sigma^2 + 1 / \tau^2} \mu
\end{align}\]</span></p>
<p>which is specifically weighted by the sample size <span class="math inline">\(n_j\)</span>. Since we assume that there is some common mean <span class="math inline">\(\mu\)</span>, our estimate of <span class="math inline">\(\theta_j\)</span> gets pulled slightly towards that common parameter <span class="math inline">\(\mu\)</span> - less so for high <span class="math inline">\(n_j\)</span>. This demonstrates the phonemonon of <em>shrinkage</em>, where information is shared across groups in this hierarchical model.</p>
<p>Again, for high <span class="math inline">\(n_j\)</span>, however, the effect of this shrinkage is neglegible.</p>
<p>Shrinkage results in some interesting phenomena. For example, look at schools 82 and 46 in our dataset.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Show R code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">THETA</span><span class="op">[</span>, <span class="fl">82</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 42.48336</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">THETA</span><span class="op">[</span>, <span class="fl">46</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 41.31501</span></span>
<span><span class="va">ybar</span><span class="op">[</span><span class="fl">82</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 38.764</span></span>
<span><span class="va">ybar</span><span class="op">[</span><span class="fl">46</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 40.17619</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Even though the sample mean of school 82 is lower than school 46, the posterior expectation of <span class="math inline">\(\theta_{82}\)</span> is <em>higher</em> than <span class="math inline">\(\theta_{46}\)</span>, because school 82 has a very small sample and thus is affected more by a pull towards <span class="math inline">\(\mu\)</span>. While this may seem counterintuitive, the explanation is that there is more evidence that <span class="math inline">\(\theta_{46}\)</span> is low than there is <span class="math inline">\(\theta_{82}\)</span> is low due to the wide discrepancy in sample sizes. The assumption that <span class="math inline">\(\theta_j\)</span> stem from one <span class="math inline">\(\mu\)</span>, then, takes a “conservative” approach to estimating the <span class="math inline">\(\theta_{82}\)</span> with little data.</p>
</section></section><section id="hierarchical-modeling-of-means-and-variances" class="level1" data-number="5"><h1 data-number="5">
<span class="header-section-number">5</span> Hierarchical modeling of means and variances</h1>
<p>The previous model assumed common variance within groups <span class="math inline">\(\sigma^2\)</span>. This is actually fairly common, perhaps less because of empirical justification for assuming common within-group variance than lack of interest in the variance of the groups. But of course, the inaccuracy of this assumption could result in errors in analysis. It’s fairly straightforward to simply add another hierarchical layer for the variance too, and jointly estimate the group-specific means and variances, as well as the common mean and variance parameters.</p>
<p>To implement this, we let <span class="math inline">\(\theta_j\)</span> depend on <span class="math inline">\(\boldsymbol{y}_j\)</span> and (new!) a group <span class="math inline">\(j\)</span>-specific <span class="math inline">\(\sigma_j^2\)</span>, so our full conditional distribution is</p>
<p><span class="math display">\[
\theta_j \mid \boldsymbol{y}_j, \sigma_j^2 \sim \mathcal{N}\left( \frac{n_j\bar{y}_j / \sigma_j^2 + 1 / \tau^2}{n_j / \sigma_j^2 + 1 / \tau^2}, \left[n_j / \sigma_j^2 + 1 / \tau^2 \right]^{-1} \right)
\]</span></p>
<p>similarly, above we had a rather special case of the full conditional of <span class="math inline">\(\sigma^2\)</span>. Since there was one common <span class="math inline">\(\sigma^2\)</span>, the posterior was based on a combination of the prior precision and the pooled sample variance. Now let’s assume that we have a separate <span class="math inline">\(\sigma_j^2\)</span> for each group:</p>
<p><span class="math display">\[\sigma_1^2, \dots, \sigma_m^2 \sim  \text{i.i.d.} \; \mathcal{N}(\nu_0 / 2, \sigma_0^2 \nu_0 / 2).\]</span></p>
<p>Now that we’re including individual <span class="math inline">\(\sigma_j^2\)</span>, re-deriving the full conditional for <span class="math inline">\(\sigma_j^2\)</span> results in full conditional distributions that look just like the one-parameter case for variance (and the corresponding <span class="math inline">\(\theta_j\)</span> conditionals for the means):</p>
<p><span class="math display">\[
\sigma_j^2 \mid \boldsymbol{y}_j, \theta_j \sim \text{inverse-gamma}\left([\nu_0 - n_j] / 2, \left[\nu_0 \sigma_0^2 + \sum_{i = 1}^{n_j}(y_{i, j} - \theta_j)^2 \right] / 2 \right)
\]</span></p>
<p>Now in the same way that we learn the group-specific parameters <span class="math inline">\(\mu, \tau^2\)</span> using prior distributions with hyperparameters <span class="math inline">\(\eta_0, \tau_0^2, \mu_0,
\gamma_0^2\)</span>, we should learn <span class="math inline">\(\nu_0, \sigma_0^2\)</span> with prior distributions.</p>
<p>Since we are modeling variances, we let <span class="math inline">\(\sigma_0^2 \sim \text{gamma}(a, b)\)</span> such that the posterior is</p>
<p><span class="math display">\[
\sigma_0^2 \mid \sigma_1^2, \dots, \sigma_m^2, \nu_0 \sim \text{gamma}\left(a + \frac{1}{2}m \nu_0, b + \frac{1}{2}\sum_{j = 1}^m (1 / \sigma_j^2)\right)
\]</span></p>
<p>Lastly, there is no simple conjugate prior for <span class="math inline">\(\nu_0\)</span> unless we restrict <span class="math inline">\(\nu_0\)</span> to be a whole number. If we let <span class="math inline">\(\nu_0 \sim \text{geometric}(\alpha)\)</span>, then (as the discrete analog of the exponential distribution) <span class="math inline">\(p(\nu_0) \sim
\text{exp}(-\alpha \nu_0)\)</span> and the full conditional distribution of <span class="math inline">\(\nu_0\)</span> can be shown to be</p>
<p><span class="math display">\[
p(\nu_0 \mid \sigma_0^2, \dots, \sigma_m^2) \propto \left( \frac{(\sigma_0^2 \nu_0 / 2)^{\nu_0 / 2}}{\Gamma(\nu_0 / 2)} \right)^m \left( \prod_{j = 1}^m \frac{1}{\sigma_j^2} \right)^{\nu_0 / 2 - 1} \times \text{exp} \left( - \nu_0 \left(\alpha + \frac{1}{2} \sigma_0^2 \sum_{j = 1}^m \frac{1}{\sigma_j^2} \right) \right)
\]</span></p>
<section id="analysis-of-math-score-data" class="level2" data-number="5.1"><h2 data-number="5.1" class="anchored" data-anchor-id="analysis-of-math-score-data">
<span class="header-section-number">5.1</span> Analysis of math score data</h2>
<p>For time I haven’t reproduced the analysis here are there aren’t too many conclusions drawn - the point is just that you can let the variance vary across groups.</p>
</section></section><section id="exercises" class="level1" data-number="6"><h1 data-number="6">
<span class="header-section-number">6</span> Exercises</h1>
<section id="section" class="level2" data-number="6.1"><h2 data-number="6.1" class="anchored" data-anchor-id="section">
<span class="header-section-number">6.1</span> 8.1</h2>
<section id="a" class="level3" data-number="6.1.1"><h3 data-number="6.1.1" class="anchored" data-anchor-id="a">
<span class="header-section-number">6.1.1</span> a</h3>
<p>I expect <span class="math inline">\(\text{Var}(y_{i, j} \mid \mu, \tau^2)\)</span> to be bigger since it includes both within- and between-group sampling variability.</p>
</section><section id="b" class="level3" data-number="6.1.2"><h3 data-number="6.1.2" class="anchored" data-anchor-id="b">
<span class="header-section-number">6.1.2</span> b</h3>
<p>I think <span class="math inline">\(\text{Cov}(y_{i_1, j}, y_{i_2, j} \mid \theta_j, \sigma^2)\)</span> is zero because, according to exchangeability, our <span class="math inline">\(y_{i, j}\)</span> are conditionally i.i.d. when <span class="math inline">\(\theta_j, \sigma^2\)</span> is known.</p>
<p>On the other hand, given our model, it seems like knowing about another <span class="math inline">\(y_{i_1,
j}\)</span> <em>does</em> provide more information about <span class="math inline">\(y_{i_2, j}\)</span>, and I expect them to covary positively with each other. Specifically, <span class="math inline">\(y_{i_1, j}\)</span> seems to give more information about what the mean <span class="math inline">\(\theta_j\)</span> is, and we expect values from the same <span class="math inline">\(\theta_j\)</span> to be closer together (due to decreased variability). I can’t come up with a more formal mathematical justification, though.</p>
</section><section id="c" class="level3" data-number="6.1.3"><h3 data-number="6.1.3" class="anchored" data-anchor-id="c">
<span class="header-section-number">6.1.3</span> c</h3>
<p><span class="math display">\[\begin{align}
\text{Var}(y_{i, j} \mid \theta_j, \sigma^2) &amp;= \sigma^2 &amp; \text{By def.}\\
\text{Var}(\bar{y}_{\cdot, j} \mid \theta_j, \sigma^2) &amp;= \sigma^2 / n_j &amp; \text{Samp. dist. mean} \\
\text{Cov}(y_{i_1, j}, y_{i_2, j} \mid \theta_j, \sigma^2) &amp;= \mathbb{E}(y_{i_1, j}y_{i_2, j}) - \mathbb{E}(y_{i_1, j})\mathbb{E}(y_{i_2, j}) \\
&amp;= \mathbb{E}(y_{i_1, j})\mathbb{E}(y_{i_2, j}) - \mathbb{E}(y_{i_1, j})\mathbb{E}(y_{i_2, j}) &amp; \text{i.i.d.} \\
&amp;= 0 \\
&amp; \\
\text{Var}(y_{i, j} \mid \mu, \tau^2) &amp;= \text{Var}(\mathbb{E}(y_{i, j} \mid \theta_j, \sigma^2) \mid \mu, \tau^2) + \mathbb{E}(\text{Var}(y_{i, j} \mid \theta_j, \sigma^2) \mid \mu, \tau^2) &amp; \text{Law total var.} \\
&amp;= \text{Var}(\theta_j \mid \mu, \tau^2) + \mathbb{E}(\sigma^2 \mid \mu, \tau^2) \\
&amp;= \tau^2 + \sigma^2 \\

\text{Var}(\bar{y}_{\cdot, j} \mid \mu, \tau^2) &amp;= \text{Var}(\mathbb{E}(\bar{y}_{\cdot, j} \mid \theta_j, \sigma^2) \mid \mu, \tau^2) + \mathbb{E}(\text{Var}(\bar{y}_{\cdot, j} \mid \theta_j, \sigma^2) \mid \mu, \tau^2) &amp; \text{Law total var.} \\
&amp;= \text{Var}(\theta_j \mid \mu, \tau^2) + \mathbb{E}(\sigma^2 / n_j \mid \mu, \tau^2) \\
&amp;= \tau^2 + (\sigma^2 / n_j) \\

\text{Cov}(y_{i_1, j}, y_{i_2, j} \mid \mu, \tau^2) &amp;= \text{E}(\text{Cov}(y_{i_1, j}, y_{i_2, j} \mid \theta_j, \sigma^2) \mid \mu, \tau^2) + \text{Cov}(\mathbb{E}(y_{i_1, j} \mid \theta_j, \sigma^2), \mathbb{E}(y_{i_2, j} \mid \theta_j, \sigma^2)) &amp; \text{Law total covar.} \\
&amp;= \text{E}(0 \mid \mu, \tau^2) + \text{Cov}(\mathbb{E}(y_{i_1, j} \mid \theta_j, \sigma^2), \mathbb{E}(y_{i_2, j} \mid \theta_j, \sigma^2)) &amp; \text{i.i.d.} \\
&amp;= \text{Cov}(\theta_j, \theta_j) \\
&amp;= \text{Var}(\theta_j) \\
&amp;= \tau^2
\end{align}\]</span></p>
<p>These values indeed align with the intuitions above. The values for the variances and covariances with <span class="math inline">\(\theta_j\)</span> unknown are simply those for <span class="math inline">\(\theta_j\)</span> known plus <span class="math inline">\(\tau^2\)</span>, the between-group sampling variability.</p>
</section><section id="d" class="level3" data-number="6.1.4"><h3 data-number="6.1.4" class="anchored" data-anchor-id="d">
<span class="header-section-number">6.1.4</span> d</h3>
<p>For convenience let <span class="math inline">\(\mathcal{D} = \{\boldsymbol{y}_1, \dots,
\boldsymbol{y}_m\}\)</span> and <span class="math inline">\(\boldsymbol{\theta} = \{ \theta_1, \dots, \theta_m \}\)</span>.</p>
<p>Also, if we treat the model as a Bayes’ net, we can use factorization to quickly extract the conditional independencies: <span class="math inline">\(P(X_1, \dots, X_n) = \prod_{i = 1}^n P(X_i \mid \text{Pa}(X_i))\)</span> where <span class="math inline">\(\text{Pa}(X)\)</span> are the parents of <span class="math inline">\(X\)</span>.</p>
<p><span class="math display">\[\begin{align}
p(\mu \mid \mathcal{D}, \boldsymbol{\theta}, \sigma^2, \tau^2) &amp;= \frac{p(\mu, \mathcal{D}, \boldsymbol{\theta}, \sigma^2, \tau^2)}{\int p(\mu, \mathcal{D}, \boldsymbol{\theta}, \sigma^2, \tau^2) \; d\mu} \\
&amp;= \frac{p(\mu) p(\tau^2) p(\sigma^2) p(\mathcal{D} \mid \boldsymbol{\theta}, \sigma^2) p(\boldsymbol{\theta} \mid \mu, \tau^2) } {\int p(\mu) p(\tau^2) p(\sigma^2) p(\mathcal{D} \mid \boldsymbol{\theta}, \sigma^2) p(\boldsymbol{\theta} \mid \mu, \tau^2)\; d\mu } &amp; \text{Factorization} \\
&amp;= \frac{p(\mu) p(\tau^2) p(\sigma^2) p(\mathcal{D} \mid \boldsymbol{\theta}, \sigma^2) p(\boldsymbol{\theta} \mid \mu, \tau^2) } { p(\tau^2) p(\sigma^2) p(\mathcal{D} \mid \boldsymbol{\theta}, \sigma^2) \int p(\mu) p(\boldsymbol{\theta} \mid \mu, \tau^2)\; d\mu } &amp; \text{Constants outside} \\
&amp;= \frac{p(\mu) p(\boldsymbol{\theta} \mid \mu, \tau^2) } { \int p(\mu) p(\boldsymbol{\theta} \mid \mu, \tau^2)\; d\mu } &amp; \\
&amp;= p(\mu \mid \boldsymbol{\theta}, \tau^2) &amp; \text{Bayes' rule}
\end{align}\]</span></p>
<p>This means that <span class="math inline">\(\mu\)</span> does not depend on the data (or <span class="math inline">\(\sigma^2\)</span>) once <span class="math inline">\(\theta_1, \dots, \theta_m\)</span> are known; another example of conditional independence induced by the Bayes network.</p>
</section></section><section id="section-1" class="level2" data-number="6.2"><h2 data-number="6.2" class="anchored" data-anchor-id="section-1">
<span class="header-section-number">6.2</span> 8.3</h2>
<section id="a-1" class="level3" data-number="6.2.1"><h3 data-number="6.2.1" class="anchored" data-anchor-id="a-1">
<span class="header-section-number">6.2.1</span> a</h3>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Show R code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Load data</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span></span>
<span><span class="va">schools.list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">8</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">s.tbl</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">'Exercises/school'</span>, <span class="va">i</span>, <span class="st">'.dat'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="va">read.table</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>    school <span class="op">=</span> <span class="va">i</span>,</span>
<span>    hours <span class="op">=</span> <span class="va">s.tbl</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as.numeric</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">schools.raw</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">schools.list</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Y</span> <span class="op">=</span> <span class="va">schools.raw</span></span>
<span></span>
<span></span>
<span><span class="co"># Prior</span></span>
<span><span class="va">mu0</span> <span class="op">=</span> <span class="fl">7</span></span>
<span><span class="va">g20</span> <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="va">t20</span> <span class="op">=</span> <span class="fl">10</span></span>
<span><span class="va">eta0</span> <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="va">s20</span> <span class="op">=</span> <span class="fl">15</span></span>
<span><span class="va">nu0</span> <span class="op">=</span> <span class="fl">2</span></span>
<span></span>
<span><span class="co"># Number of schools. Y[, 1] are school ids</span></span>
<span><span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">Y</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Starting values - use sample mean and variance</span></span>
<span><span class="va">n</span> <span class="op">=</span> <span class="va">sv</span> <span class="op">=</span> <span class="va">ybar</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">m</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">m</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">Y_j</span> <span class="op">=</span> <span class="va">Y</span><span class="op">[</span><span class="va">Y</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="va">j</span>, <span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="va">ybar</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_j</span><span class="op">)</span></span>
<span>  <span class="va">sv</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">var</a></span><span class="op">(</span><span class="va">Y_j</span><span class="op">)</span></span>
<span>  <span class="va">n</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">Y_j</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Let initial theta estimates be the sample means</span></span>
<span><span class="co"># Similarly, let initial values of sigma2, mu, and tau2 be "sample mean and</span></span>
<span><span class="co"># variance"</span></span>
<span><span class="va">theta</span> <span class="op">=</span> <span class="va">ybar</span></span>
<span><span class="va">sigma2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">sv</span><span class="op">)</span></span>
<span><span class="va">mu</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span></span>
<span><span class="va">tau2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">var</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># MCMC</span></span>
<span><span class="va">S</span> <span class="op">=</span> <span class="fl">1500</span></span>
<span><span class="va">THETA</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="va">S</span>, ncol <span class="op">=</span> <span class="va">m</span><span class="op">)</span></span>
<span><span class="co"># Storing sigma, mu, theta together</span></span>
<span><span class="va">SMT</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="va">S</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">SMT</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'sigma2'</span>, <span class="st">'mu'</span>, <span class="st">'tau2'</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">S</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Sample thetas</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">m</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">vtheta</span> <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="va">n</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">/</span> <span class="va">sigma2</span> <span class="op">+</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">tau2</span><span class="op">)</span></span>
<span>    <span class="va">etheta</span> <span class="op">=</span> <span class="va">vtheta</span> <span class="op">*</span> <span class="op">(</span><span class="va">ybar</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">*</span> <span class="va">n</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">/</span> <span class="va">sigma2</span> <span class="op">+</span> <span class="va">mu</span> <span class="op">/</span> <span class="va">tau2</span><span class="op">)</span></span>
<span>    <span class="va">theta</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">etheta</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">vtheta</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Sample sigma2</span></span>
<span>  <span class="va">nun</span> <span class="op">=</span> <span class="va">nu0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="co"># TODO: Could cache this</span></span>
<span>  <span class="va">ss</span> <span class="op">=</span> <span class="va">nu0</span> <span class="op">*</span> <span class="va">s20</span></span>
<span>  <span class="co"># Pool variance</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">m</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">ss</span> <span class="op">=</span> <span class="va">ss</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">Y</span><span class="op">[</span><span class="va">Y</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="va">j</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">theta</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">sigma2</span> <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html">rgamma</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">nun</span> <span class="op">/</span> <span class="fl">2</span>, <span class="va">ss</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Sample mu</span></span>
<span>  <span class="va">vmu</span> <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="va">m</span> <span class="op">/</span> <span class="va">tau2</span> <span class="op">+</span> <span class="fl">1</span> <span class="op">/</span><span class="va">g20</span><span class="op">)</span></span>
<span>  <span class="va">emu</span> <span class="op">=</span> <span class="va">vmu</span> <span class="op">*</span> <span class="op">(</span><span class="va">m</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span> <span class="op">/</span> <span class="va">tau2</span> <span class="op">+</span> <span class="va">mu0</span> <span class="op">/</span> <span class="va">g20</span><span class="op">)</span></span>
<span>  <span class="va">mu</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">emu</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">vmu</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Sample tau2</span></span>
<span>  <span class="va">etam</span> <span class="op">=</span> <span class="va">eta0</span> <span class="op">+</span> <span class="va">m</span></span>
<span>  <span class="va">ss</span> <span class="op">=</span> <span class="va">eta0</span> <span class="op">*</span> <span class="va">t20</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">theta</span> <span class="op">-</span> <span class="va">mu</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">tau2</span> <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html">rgamma</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">etam</span> <span class="op">/</span> <span class="fl">2</span>, <span class="va">ss</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Store params</span></span>
<span>  <span class="va">THETA</span><span class="op">[</span><span class="va">s</span>, <span class="op">]</span> <span class="op">=</span> <span class="va">theta</span></span>
<span>  <span class="va">SMT</span><span class="op">[</span><span class="va">s</span>, <span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">sigma2</span>, <span class="va">mu</span>, <span class="va">tau2</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Assess convergence with diagnostic boxplots:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-8-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-74"><img src="8_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
<p>Evaluate effective sample size:</p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Show R code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Tweak number of samples until all of the below are above 1000</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">coda</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/effectiveSize.html">effectiveSize</a></span><span class="op">(</span><span class="va">SMT</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;     var1 </span></span>
<span><span class="co">#&gt; 1509.853</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/effectiveSize.html">effectiveSize</a></span><span class="op">(</span><span class="va">SMT</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;     var1 </span></span>
<span><span class="co">#&gt; 1238.402</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/effectiveSize.html">effectiveSize</a></span><span class="op">(</span><span class="va">SMT</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;     var1 </span></span>
<span><span class="co">#&gt; 1036.337</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section><section id="b-1" class="level3" data-number="6.2.2"><h3 data-number="6.2.2" class="anchored" data-anchor-id="b-1">
<span class="header-section-number">6.2.2</span> b</h3>
<p>Posterior means and confidence intervals</p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Show R code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">SMT</span>, MARGIN <span class="op">=</span> <span class="fl">2</span>, FUN <span class="op">=</span> <span class="va">quantile</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;             2.5%       50%     97.5%</span></span>
<span><span class="co">#&gt; sigma2 11.736878 14.376589 17.775544</span></span>
<span><span class="co">#&gt; mu      5.945417  7.546141  9.182105</span></span>
<span><span class="co">#&gt; tau2    1.836294  4.683608 14.643933</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Comparing posterior to prior:</p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Show R code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># For dinvgamma</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://CRAN.R-project.org/package=MCMCpack">MCMCpack</a></span><span class="op">)</span></span>
<span><span class="va">sigma2_prior</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">22.5</span>, by <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>,</span>
<span>  density <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/MCMCpack/man/InvGamma.html">dinvgamma</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">22.5</span>, by <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>, <span class="va">nu0</span> <span class="op">/</span> <span class="fl">2</span>, <span class="va">nu0</span> <span class="op">*</span> <span class="va">s20</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>  variable <span class="op">=</span> <span class="st">'sigma2'</span></span>
<span><span class="op">)</span></span>
<span><span class="va">tau2_prior</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">30</span>, by <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>,</span>
<span>  density <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/MCMCpack/man/InvGamma.html">dinvgamma</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">30</span>, by <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>, <span class="va">eta0</span> <span class="op">/</span> <span class="fl">2</span>, <span class="va">eta0</span> <span class="op">*</span> <span class="va">t20</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>  variable <span class="op">=</span> <span class="st">'tau2'</span></span>
<span><span class="op">)</span></span>
<span><span class="va">mu_prior</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">12</span>, by <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>,</span>
<span>  density <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">12</span>, by <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>, <span class="va">mu0</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">g20</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  variable <span class="op">=</span> <span class="st">'mu'</span></span>
<span><span class="op">)</span></span>
<span><span class="va">priors</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">sigma2_prior</span>, <span class="va">tau2_prior</span>, <span class="va">mu_prior</span><span class="op">)</span></span>
<span><span class="va">priors</span><span class="op">$</span><span class="va">dist</span> <span class="op">=</span> <span class="st">'prior'</span></span>
<span><span class="va">smt.df</span><span class="op">$</span><span class="va">dist</span> <span class="op">=</span> <span class="st">'posterior'</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">priors</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">value</span>, y <span class="op">=</span> <span class="va">density</span>, color <span class="op">=</span> <span class="va">dist</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_density</span><span class="op">(</span>data <span class="op">=</span> <span class="va">smt.df</span>, mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">value</span>, y <span class="op">=</span> <span class="va">..density..</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span> <span class="va">variable</span>, scales <span class="op">=</span> <span class="st">'free'</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-11-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-75"><img src="8_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
<p>Our prior estimates for <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\tau^2\)</span> were fairly estimate, but our estimate for <span class="math inline">\(\sigma^2\)</span> was very far off. After this analysis, we have estimates for <span class="math inline">\(\mu\)</span>, the average amount of hours of schoolwork spent at a typical school, <span class="math inline">\(\tau^2\)</span>, the variability between schools in the average hours of schoolwork, and <span class="math inline">\(\sigma^2\)</span>, the variability among students’ hours in each school.</p>
</section><section id="c-1" class="level3" data-number="6.2.3"><h3 data-number="6.2.3" class="anchored" data-anchor-id="c-1">
<span class="header-section-number">6.2.3</span> c</h3>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Show R code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">t20_prior</span> <span class="op">=</span> <span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html">rgamma</a></span><span class="op">(</span><span class="fl">1e6</span>, <span class="va">eta0</span> <span class="op">/</span> <span class="fl">2</span>, <span class="va">eta0</span> <span class="op">*</span> <span class="va">t20</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">s20_prior</span> <span class="op">=</span> <span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html">rgamma</a></span><span class="op">(</span><span class="fl">1e6</span>, <span class="va">nu0</span> <span class="op">/</span> <span class="fl">2</span>, <span class="va">nu0</span> <span class="op">*</span> <span class="va">s20</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">R_prior</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  value <span class="op">=</span> <span class="op">(</span><span class="va">t20_prior</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">t20_prior</span> <span class="op">+</span> <span class="va">s20_prior</span><span class="op">)</span>,</span>
<span>  dist <span class="op">=</span> <span class="st">'prior'</span></span>
<span><span class="op">)</span></span>
<span><span class="va">R_post</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  value <span class="op">=</span> <span class="va">SMT</span><span class="op">[</span>, <span class="st">'tau2'</span><span class="op">]</span> <span class="op">/</span> <span class="op">(</span><span class="va">SMT</span><span class="op">[</span>, <span class="st">'tau2'</span><span class="op">]</span> <span class="op">+</span> <span class="va">SMT</span><span class="op">[</span>, <span class="st">'sigma2'</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  dist <span class="op">=</span> <span class="st">'posterior'</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">R_prior</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">value</span>, y <span class="op">=</span> <span class="va">..density..</span>, color <span class="op">=</span> <span class="va">dist</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_density</span><span class="op">(</span>data <span class="op">=</span> <span class="va">R_prior</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_density</span><span class="op">(</span>data <span class="op">=</span> <span class="va">R_post</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-12-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-76"><img src="8_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
<details class="code-fold"><summary>Show R code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">R_post</span><span class="op">$</span><span class="va">value</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.2616334</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p><span class="math inline">\(R\)</span> measures how much of the total variance in our data is between-group. Our prior didn’t contain much information about this quantity, but after inference, we expect that around 25% of our variance comes from between group variance (<span class="math inline">\(\tau^2\)</span>).</p>
</section><section id="d-1" class="level3" data-number="6.2.4"><h3 data-number="6.2.4" class="anchored" data-anchor-id="d-1">
<span class="header-section-number">6.2.4</span> d</h3>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Show R code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">theta7_lt_6</span> <span class="op">=</span> <span class="va">THETA</span><span class="op">[</span>, <span class="fl">7</span><span class="op">]</span> <span class="op">&lt;</span> <span class="va">THETA</span><span class="op">[</span>, <span class="fl">6</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">theta7_lt_6</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.5473333</span></span>
<span></span>
<span><span class="va">theta7_smallest</span> <span class="op">=</span> <span class="op">(</span><span class="va">THETA</span><span class="op">[</span>, <span class="fl">7</span><span class="op">]</span> <span class="op">&lt;</span> <span class="va">THETA</span><span class="op">[</span>, <span class="op">-</span><span class="fl">7</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span>MARGIN <span class="op">=</span> <span class="fl">1</span>, FUN <span class="op">=</span> <span class="va">all</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">theta7_smallest</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.336</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section><section id="e" class="level3" data-number="6.2.5"><h3 data-number="6.2.5" class="anchored" data-anchor-id="e">
<span class="header-section-number">6.2.5</span> e</h3>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Show R code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">relationship</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  sample_average <span class="op">=</span> <span class="va">ybar</span>,</span>
<span>  post_exp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">THETA</span><span class="op">)</span>,</span>
<span>  school <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">ybar</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">relationship</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">sample_average</span>, y <span class="op">=</span> <span class="va">post_exp</span>, label <span class="op">=</span> <span class="va">school</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_text</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_abline</span><span class="op">(</span>slope <span class="op">=</span> <span class="fl">1</span>, intercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">schools.raw</span><span class="op">[</span>, <span class="st">'hours'</span><span class="op">]</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span><span class="st">'text'</span>, x <span class="op">=</span> <span class="fl">10</span>, y <span class="op">=</span> <span class="fl">7.9</span>, label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Pooled sample mean "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">schools.raw</span><span class="op">[</span>, <span class="st">'hours'</span><span class="op">]</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">SMT</span><span class="op">[</span>, <span class="st">'mu'</span><span class="op">]</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span><span class="st">'text'</span>, x <span class="op">=</span> <span class="fl">10</span>, y <span class="op">=</span> <span class="fl">7.4</span>, label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Posterior exp. mu "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">SMT</span><span class="op">[</span>, <span class="st">'mu'</span><span class="op">]</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="8_files/figure-html/unnamed-chunk-14-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-77"><img src="8_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
<p>There is a quite tight correspondence between the sample average and the posterior expectation, although mild shrinkage can be observed with schools with very high and low sample averages being pulled towards the mean.</p>


<!-- -->

</section></section></section><a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/d-morrison\.github\.io\/hoff-bayesian-statistics\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // default icon
            link.classList.add("external");
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Chapter 8: Group comparisons and hierarchical modeling"</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Jesse Mu"</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "November 17, 2016"</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Setup --&gt;</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE, message=FALSE}</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">fig.align =</span> <span class="st">'center'</span>, <span class="at">message =</span> <span class="cn">FALSE</span>)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cowplot)</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reshape)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Begin writing --&gt;</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>A common task in data analysis is to compare summary statistics for two or more</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>groups. In this chapter we cover the Bayesian approach to doing this.</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a><span class="fu"># Comparing two groups</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>A standard method in (frequentist) introductory statistics for comparing the </span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>means of two populations is to compute the $t$-statistic of the observed mean </span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>difference and obtain the two-sided $p$-value. Then, if $p &lt; 0.05$ (or any other</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>significance level), we reject the null hypothesis that the two groups have the </span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>same mean, and use the estimates $\hat{\theta}_1 = \bar{y}_1$ and </span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>$\hat{\theta}_2 = \bar{y}_2$ (i.e. the ML estimators for $\theta_1$ and </span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>$\theta_2$ independently). Otherwise, we accept the null hypothesis that the two</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>groups have the same mean and let $\hat{\theta}_1 = \hat{\theta}_2$ be the </span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>pooled mean of the two groups.</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>There are many situations in which this paradigm doesn't make too much sense.</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>Consider borderline cases in which our $p$-value is close to 0.05. It seems like</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>a technicality to treat the means as completely different if e.g. $p = 0.051$,</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>and completely the same if $p = 0.049$ - a difference that could hypothetically</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>be observed by simply sampling one more data point.</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>The Bayesian approach is to treat the two populations as being sampled from a </span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>common mean $\theta$ plus some difference $\delta$, where we estimate both </span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>$\theta$ and $\delta$. Then the observed difference $\delta$ can vary </span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>continuously. Specifically, our sampling model for a value from either group is</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$Y_{i, 1} = \mu + \delta + \epsilon_{i, 1}$</span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$Y_{i, 2} = \mu + \delta + \epsilon_{i, 2}$</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>where we assume values from both groups have a common variance $\epsilon_{i, j} \sim \text{i.i.d.}\; \mathcal{N}(0, \sigma^2)$.</span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a><span class="fu">## Prior and posterior distributions</span></span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a><span class="fu">### Prior</span></span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>The joint prior for all three parameters of our model $\mu, \delta, \sigma^2$ is</span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>unsurprising. We treat the parameters as independent, so $p(\mu, \delta, \sigma^2) = p(\mu) p(\delta) p(\sigma^2)$ where</span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\mu \sim \mathcal{N}(\mu_0, \gamma_0^2)$</span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\delta \sim \mathcal{N}(\delta_0, \tau_0^2)$</span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\sigma^2 \sim \text{inverse-gamma}(\nu_0 / 2, \sigma_0^2 \nu_0 / 2)$</span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>Notice that we specify prior distributions for the common mean and variance, but</span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a>we also express an estimate (and certainty of the estimate) for the difference</span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a>between the group means $\delta$.</span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a><span class="fu">### Posterior</span></span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a>Then the full conditional distributions of the parameters are</span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\mu \mid \boldsymbol{y}_1, \boldsymbol{y}_2, \delta, \sigma^2 \sim \mathcal{N}(\mu_n, \gamma_n^2)$</span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>$\mu_n = \gamma_n^2 \times \left[ \mu_0 / \gamma_0^2 + \sum_{i = 1}^{n_1} (y_{i, 1} - \delta) / \sigma^2 + \sum_{i = 1}^{n_2}(y_{i, 2} + \delta) / \sigma^2 \right]$</span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>$\gamma_n^2 = \left<span class="co">[</span><span class="ot"> 1/\gamma_0^2 + (n_1 + n_2) / \sigma^2  \right</span><span class="co">]</span>^{-1}$</span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\delta \mid \boldsymbol{y}_1, \boldsymbol{y}_2, \mu, \sigma^2 \sim \mathcal{N}(\delta_n, \tau_n^2)$</span>
<span id="cb15-73"><a href="#cb15-73" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>$\delta_n = \tau_n^2 \times \left[ \delta_0 / \tau_0^2 + \sum_{i = 1}^{n_1} (y_{i, 1} - \mu) / \sigma^2 - \sum_{i = 1}^{n_2} (y_{i, 2} - \mu) / \sigma^2 \right]$</span>
<span id="cb15-74"><a href="#cb15-74" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>$\tau_n^2 = \left<span class="co">[</span><span class="ot"> 1 / \tau_0^2 + (n_1 + n_2) / \sigma^2 \right</span><span class="co">]</span>^{-1}$</span>
<span id="cb15-75"><a href="#cb15-75" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\sigma^2 \mid \boldsymbol{y}_1, \boldsymbol{y}_2, \mu, \delta \sim \text{inverse-gamma}(\nu_n / 2, \sigma_n^2 \nu_n / 2)$</span>
<span id="cb15-76"><a href="#cb15-76" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>$\nu_n = \nu_0 + n_1 + n_2$</span>
<span id="cb15-77"><a href="#cb15-77" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>$\nu_n \sigma_n^2 = \nu_0 \sigma_0^2 + \sum_{i = 1}^{n_1} (y_{i, 1} - \left[\mu + \delta \right])^2 + \sum_{i = 1}^{n_2} (y_{i, 2} - \left<span class="co">[</span><span class="ot"> \mu - \delta \right</span><span class="co">]</span>)^2$</span>
<span id="cb15-78"><a href="#cb15-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-79"><a href="#cb15-79" aria-hidden="true" tabindex="-1"></a><span class="fu">## Analysis of the math score data</span></span>
<span id="cb15-80"><a href="#cb15-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-83"><a href="#cb15-83" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb15-84"><a href="#cb15-84" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">'Replication/chapter8.R'</span>)</span>
<span id="cb15-85"><a href="#cb15-85" aria-hidden="true" tabindex="-1"></a>y1 <span class="ot">=</span> y.school1</span>
<span id="cb15-86"><a href="#cb15-86" aria-hidden="true" tabindex="-1"></a>y2 <span class="ot">=</span> y.school2</span>
<span id="cb15-87"><a href="#cb15-87" aria-hidden="true" tabindex="-1"></a>n1 <span class="ot">=</span> <span class="fu">length</span>(y1)</span>
<span id="cb15-88"><a href="#cb15-88" aria-hidden="true" tabindex="-1"></a>n2 <span class="ot">=</span> <span class="fu">length</span>(y2)</span>
<span id="cb15-89"><a href="#cb15-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-90"><a href="#cb15-90" aria-hidden="true" tabindex="-1"></a><span class="co"># Priors</span></span>
<span id="cb15-91"><a href="#cb15-91" aria-hidden="true" tabindex="-1"></a>mu0 <span class="ot">=</span> <span class="dv">50</span></span>
<span id="cb15-92"><a href="#cb15-92" aria-hidden="true" tabindex="-1"></a>g20 <span class="ot">=</span> <span class="dv">625</span></span>
<span id="cb15-93"><a href="#cb15-93" aria-hidden="true" tabindex="-1"></a>del0 <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb15-94"><a href="#cb15-94" aria-hidden="true" tabindex="-1"></a>t20 <span class="ot">=</span> <span class="dv">625</span></span>
<span id="cb15-95"><a href="#cb15-95" aria-hidden="true" tabindex="-1"></a>s20 <span class="ot">=</span> <span class="dv">100</span></span>
<span id="cb15-96"><a href="#cb15-96" aria-hidden="true" tabindex="-1"></a>nu0 <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb15-97"><a href="#cb15-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-98"><a href="#cb15-98" aria-hidden="true" tabindex="-1"></a><span class="co"># starting values based on ML estimates</span></span>
<span id="cb15-99"><a href="#cb15-99" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">=</span> (<span class="fu">mean</span>(y1) <span class="sc">+</span> <span class="fu">mean</span>(y2)) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb15-100"><a href="#cb15-100" aria-hidden="true" tabindex="-1"></a>del <span class="ot">=</span> (<span class="fu">mean</span>(y1) <span class="sc">-</span> <span class="fu">mean</span>(y2)) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb15-101"><a href="#cb15-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-102"><a href="#cb15-102" aria-hidden="true" tabindex="-1"></a><span class="co"># Gibbs sampler</span></span>
<span id="cb15-103"><a href="#cb15-103" aria-hidden="true" tabindex="-1"></a>S <span class="ot">=</span> <span class="dv">5000</span></span>
<span id="cb15-104"><a href="#cb15-104" aria-hidden="true" tabindex="-1"></a>MU <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">0</span>, S)</span>
<span id="cb15-105"><a href="#cb15-105" aria-hidden="true" tabindex="-1"></a>DEL <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">0</span>, S)</span>
<span id="cb15-106"><a href="#cb15-106" aria-hidden="true" tabindex="-1"></a>S2 <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">0</span>, S)</span>
<span id="cb15-107"><a href="#cb15-107" aria-hidden="true" tabindex="-1"></a>Y12 <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> S, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb15-108"><a href="#cb15-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-109"><a href="#cb15-109" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb15-110"><a href="#cb15-110" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (s <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>S)  {</span>
<span id="cb15-111"><a href="#cb15-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-112"><a href="#cb15-112" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sample s2 according to p.128 eq 3</span></span>
<span id="cb15-113"><a href="#cb15-113" aria-hidden="true" tabindex="-1"></a>  s2 <span class="ot">=</span> <span class="dv">1</span> <span class="sc">/</span> <span class="fu">rgamma</span>(<span class="dv">1</span>, (nu0 <span class="sc">+</span> n1 <span class="sc">+</span> n2) <span class="sc">/</span> <span class="dv">2</span>,</span>
<span id="cb15-114"><a href="#cb15-114" aria-hidden="true" tabindex="-1"></a>                  (nu0 <span class="sc">*</span> s20 <span class="sc">+</span> <span class="fu">sum</span>((y1 <span class="sc">-</span> mu <span class="sc">-</span> del)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">sum</span>((y2 <span class="sc">-</span> mu <span class="sc">+</span> del)<span class="sc">^</span><span class="dv">2</span>)) <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb15-115"><a href="#cb15-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-116"><a href="#cb15-116" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sample mu according to p.128 eq 1</span></span>
<span id="cb15-117"><a href="#cb15-117" aria-hidden="true" tabindex="-1"></a>  var.mu <span class="ot">=</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">/</span> g20 <span class="sc">+</span> (n1 <span class="sc">+</span> n2) <span class="sc">/</span> s2)</span>
<span id="cb15-118"><a href="#cb15-118" aria-hidden="true" tabindex="-1"></a>  mean.mu <span class="ot">=</span> var.mu <span class="sc">*</span> (mu0<span class="sc">/</span>g20 <span class="sc">+</span> <span class="fu">sum</span>(y1 <span class="sc">-</span> del) <span class="sc">/</span> s2 <span class="sc">+</span> <span class="fu">sum</span>(y2 <span class="sc">+</span> del) <span class="sc">/</span> s2)</span>
<span id="cb15-119"><a href="#cb15-119" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, mean.mu, <span class="fu">sqrt</span>(var.mu))</span>
<span id="cb15-120"><a href="#cb15-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-121"><a href="#cb15-121" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sample del according to p.128 eq 2</span></span>
<span id="cb15-122"><a href="#cb15-122" aria-hidden="true" tabindex="-1"></a>  var.del <span class="ot">=</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">/</span> t20 <span class="sc">+</span> (n1 <span class="sc">+</span> n2) <span class="sc">/</span> s2 )</span>
<span id="cb15-123"><a href="#cb15-123" aria-hidden="true" tabindex="-1"></a>  mean.del <span class="ot">=</span> var.del <span class="sc">*</span> (del0 <span class="sc">/</span> t20 <span class="sc">+</span> <span class="fu">sum</span>(y1 <span class="sc">-</span> mu) <span class="sc">/</span> s2 <span class="sc">-</span> <span class="fu">sum</span>(y2 <span class="sc">-</span> mu) <span class="sc">/</span> s2)</span>
<span id="cb15-124"><a href="#cb15-124" aria-hidden="true" tabindex="-1"></a>  del <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, mean.del, <span class="fu">sqrt</span>(var.del))</span>
<span id="cb15-125"><a href="#cb15-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-126"><a href="#cb15-126" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Store params</span></span>
<span id="cb15-127"><a href="#cb15-127" aria-hidden="true" tabindex="-1"></a>  MU[s] <span class="ot">=</span> mu</span>
<span id="cb15-128"><a href="#cb15-128" aria-hidden="true" tabindex="-1"></a>  DEL[s] <span class="ot">=</span> del</span>
<span id="cb15-129"><a href="#cb15-129" aria-hidden="true" tabindex="-1"></a>  S2[s] <span class="ot">=</span> s2</span>
<span id="cb15-130"><a href="#cb15-130" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sample from posterior</span></span>
<span id="cb15-131"><a href="#cb15-131" aria-hidden="true" tabindex="-1"></a>  Y12[s, ] <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">2</span>, mu <span class="sc">+</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>) <span class="sc">*</span> del, <span class="fu">sqrt</span>(s2))</span>
<span id="cb15-132"><a href="#cb15-132" aria-hidden="true" tabindex="-1"></a>}                 </span>
<span id="cb15-133"><a href="#cb15-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-134"><a href="#cb15-134" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="at">mu =</span> MU)) <span class="sc">+</span></span>
<span id="cb15-135"><a href="#cb15-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">x =</span> mu))</span>
<span id="cb15-136"><a href="#cb15-136" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-137"><a href="#cb15-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-138"><a href="#cb15-138" aria-hidden="true" tabindex="-1"></a>Now we can directly estimate the probability that $\delta &gt; 0$:</span>
<span id="cb15-139"><a href="#cb15-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-142"><a href="#cb15-142" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb15-143"><a href="#cb15-143" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(DEL <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb15-144"><a href="#cb15-144" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-145"><a href="#cb15-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-146"><a href="#cb15-146" aria-hidden="true" tabindex="-1"></a>as well as the probability that an individual from school 1 is higher than school 2, which due to variance is a bit lower:</span>
<span id="cb15-147"><a href="#cb15-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-150"><a href="#cb15-150" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb15-151"><a href="#cb15-151" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(Y12[, <span class="dv">1</span>] <span class="sc">&gt;</span> Y12[, <span class="dv">2</span>])</span>
<span id="cb15-152"><a href="#cb15-152" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-153"><a href="#cb15-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-154"><a href="#cb15-154" aria-hidden="true" tabindex="-1"></a><span class="fu"># Comparing multiple groups</span></span>
<span id="cb15-155"><a href="#cb15-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-156"><a href="#cb15-156" aria-hidden="true" tabindex="-1"></a>Let's extend this to a $&gt; 2$ group case. Assume for our example above that we</span>
<span id="cb15-157"><a href="#cb15-157" aria-hidden="true" tabindex="-1"></a>have many schools, which we assume are samples from a populatio of schools. So</span>
<span id="cb15-158"><a href="#cb15-158" aria-hidden="true" tabindex="-1"></a>our dataset is *hierarchical* or *multilevel* since there are samples of schools</span>
<span id="cb15-159"><a href="#cb15-159" aria-hidden="true" tabindex="-1"></a>and within each school samples of students.</span>
<span id="cb15-160"><a href="#cb15-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-161"><a href="#cb15-161" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exchangeability and hierarchical models</span></span>
<span id="cb15-162"><a href="#cb15-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-163"><a href="#cb15-163" aria-hidden="true" tabindex="-1"></a>Using de Finetti's theorem and assuming exchangability, we knew previously that</span>
<span id="cb15-164"><a href="#cb15-164" aria-hidden="true" tabindex="-1"></a>for a single group, we can treat the data within the group as being</span>
<span id="cb15-165"><a href="#cb15-165" aria-hidden="true" tabindex="-1"></a>conditionally i.i.d. given a parameter, which we call the **within-group sampling variability**:</span>
<span id="cb15-166"><a href="#cb15-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-167"><a href="#cb15-167" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-168"><a href="#cb15-168" aria-hidden="true" tabindex="-1"></a><span class="sc">\{</span>Y_{1, j}, \dots, Y_{n_{j}, j} \mid \phi_j<span class="sc">\}</span> \sim \text{i.i.d.}\; p(y \mid \phi_j)</span>
<span id="cb15-169"><a href="#cb15-169" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-170"><a href="#cb15-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-171"><a href="#cb15-171" aria-hidden="true" tabindex="-1"></a>Further, if we have many groups with parameters $\phi_j$ that we assume are</span>
<span id="cb15-172"><a href="#cb15-172" aria-hidden="true" tabindex="-1"></a>sampled from a population of *groups* we can again use de Finetti's theorem to</span>
<span id="cb15-173"><a href="#cb15-173" aria-hidden="true" tabindex="-1"></a>treat the group means $\phi_j$ as conditionally i.i.d. given another parameter,</span>
<span id="cb15-174"><a href="#cb15-174" aria-hidden="true" tabindex="-1"></a>which we call the **between-group sampling variability**:</span>
<span id="cb15-175"><a href="#cb15-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-176"><a href="#cb15-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-177"><a href="#cb15-177" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-178"><a href="#cb15-178" aria-hidden="true" tabindex="-1"></a><span class="sc">\{</span>\phi_{1}, \dots, \phi_{m} \mid \psi<span class="sc">\}</span> \sim \text{i.i.d.} \; p(\phi \mid \psi)</span>
<span id="cb15-179"><a href="#cb15-179" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-180"><a href="#cb15-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-181"><a href="#cb15-181" aria-hidden="true" tabindex="-1"></a>Then we simply need a prior distribution on the parameter for the group parameters (a "hyperparameter") $\psi$:</span>
<span id="cb15-182"><a href="#cb15-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-183"><a href="#cb15-183" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-184"><a href="#cb15-184" aria-hidden="true" tabindex="-1"></a>\psi \sim p(\psi)</span>
<span id="cb15-185"><a href="#cb15-185" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-186"><a href="#cb15-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-187"><a href="#cb15-187" aria-hidden="true" tabindex="-1"></a>Note that we can extend this hierarchy arbitrarily.</span>
<span id="cb15-188"><a href="#cb15-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-189"><a href="#cb15-189" aria-hidden="true" tabindex="-1"></a><span class="fu"># The hierarchical normal model</span></span>
<span id="cb15-190"><a href="#cb15-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-191"><a href="#cb15-191" aria-hidden="true" tabindex="-1"></a>The key of the hierarchical normal model is to treat the data within a group as</span>
<span id="cb15-192"><a href="#cb15-192" aria-hidden="true" tabindex="-1"></a>being normally distributed with some mean $\theta_j$ and variance $\sigma^2$, and the means among</span>
<span id="cb15-193"><a href="#cb15-193" aria-hidden="true" tabindex="-1"></a>groups to *also* be normally distributed according to some other mean $\mu$ and</span>
<span id="cb15-194"><a href="#cb15-194" aria-hidden="true" tabindex="-1"></a>variance $\tau^2$. Note that for now we're assuming that the data within groups share a </span>
<span id="cb15-195"><a href="#cb15-195" aria-hidden="true" tabindex="-1"></a>common variance $\sigma^2$ that doesn't depend on the group $j$.</span>
<span id="cb15-196"><a href="#cb15-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-197"><a href="#cb15-197" aria-hidden="true" tabindex="-1"></a>Specifically, we have</span>
<span id="cb15-198"><a href="#cb15-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-199"><a href="#cb15-199" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$Y_{i, j} \sim \mathcal{N}(\theta_j, \sigma^2)$</span>
<span id="cb15-200"><a href="#cb15-200" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\theta_j \sim \mathcal{N}(\mu, \tau^2)$</span>
<span id="cb15-201"><a href="#cb15-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-202"><a href="#cb15-202" aria-hidden="true" tabindex="-1"></a>So for $m$ groups, we have unknown parameters $<span class="sc">\{</span>\theta_1, \dots, \theta_m<span class="sc">\}</span>$, </span>
<span id="cb15-203"><a href="#cb15-203" aria-hidden="true" tabindex="-1"></a>the within-group variance $\sigma^2$, and the mean and variance of the group </span>
<span id="cb15-204"><a href="#cb15-204" aria-hidden="true" tabindex="-1"></a>means $(\mu, \tau^2)$. Notice that there are three fixed parameters for which we</span>
<span id="cb15-205"><a href="#cb15-205" aria-hidden="true" tabindex="-1"></a>need to specify prior distributions: $\mu$, $\tau^2$, and $\sigma^2$. Our priors</span>
<span id="cb15-206"><a href="#cb15-206" aria-hidden="true" tabindex="-1"></a>will be standard inverse-gamma and normal semiconjugate priors:</span>
<span id="cb15-207"><a href="#cb15-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-208"><a href="#cb15-208" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb15-209"><a href="#cb15-209" aria-hidden="true" tabindex="-1"></a>\sigma^2 &amp;\sim \text{inverse-gamma}(\nu_0 / 2, \sigma_0^2 \nu_0 / 2) <span class="sc">\\</span></span>
<span id="cb15-210"><a href="#cb15-210" aria-hidden="true" tabindex="-1"></a>\tau^2 &amp;\sim \text{inverse-gamma}(\eta_0 / 2, \tau_0^2 \eta_0 / 2) <span class="sc">\\</span></span>
<span id="cb15-211"><a href="#cb15-211" aria-hidden="true" tabindex="-1"></a>\mu^2 &amp;\sim \mathcal{N}(\mu_0, \gamma_0^2)</span>
<span id="cb15-212"><a href="#cb15-212" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb15-213"><a href="#cb15-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-214"><a href="#cb15-214" aria-hidden="true" tabindex="-1"></a>**Fig 8.3** isn't reproduced here in these notes but is important for</span>
<span id="cb15-215"><a href="#cb15-215" aria-hidden="true" tabindex="-1"></a>visualizing the model. It especially helps to know how Bayesian networks are interpreted,</span>
<span id="cb15-216"><a href="#cb15-216" aria-hidden="true" tabindex="-1"></a>which helps explain the conditional dependencies.</span>
<span id="cb15-217"><a href="#cb15-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-218"><a href="#cb15-218" aria-hidden="true" tabindex="-1"></a><span class="fu">## Posterior inference</span></span>
<span id="cb15-219"><a href="#cb15-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-220"><a href="#cb15-220" aria-hidden="true" tabindex="-1"></a><span class="fu">### Intuition</span></span>
<span id="cb15-221"><a href="#cb15-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-222"><a href="#cb15-222" aria-hidden="true" tabindex="-1"></a>We have samples from $m$ groups $<span class="sc">\{</span>\boldsymbol{y}_1, \dots, \boldsymbol{y}_m<span class="sc">\}</span>$. Our task is to sample from the posterior distribution</span>
<span id="cb15-223"><a href="#cb15-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-224"><a href="#cb15-224" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-225"><a href="#cb15-225" aria-hidden="true" tabindex="-1"></a>p(\theta_1, \dots, \theta_m, \mu, \tau^2, \sigma^2 \mid \boldsymbol{y}_1, \dots, \boldsymbol{y}_m)</span>
<span id="cb15-226"><a href="#cb15-226" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-227"><a href="#cb15-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-228"><a href="#cb15-228" aria-hidden="true" tabindex="-1"></a>for which we'll use a Gibbs sampler. We need to find the full conditionals for</span>
<span id="cb15-229"><a href="#cb15-229" aria-hidden="true" tabindex="-1"></a>all unknown quantities above, which seems intimidating. In the Chapter 6 notes</span>
<span id="cb15-230"><a href="#cb15-230" aria-hidden="true" tabindex="-1"></a>("a shortcut for thinking about full conditionals"), however, I mention that</span>
<span id="cb15-231"><a href="#cb15-231" aria-hidden="true" tabindex="-1"></a>obtaining the full conditional for a single parameter is fairly straightforward</span>
<span id="cb15-232"><a href="#cb15-232" aria-hidden="true" tabindex="-1"></a>by simply writing the entire joint posterior but then treating the other</span>
<span id="cb15-233"><a href="#cb15-233" aria-hidden="true" tabindex="-1"></a>parameters as constants that can be discarded via proportionality.</span>
<span id="cb15-234"><a href="#cb15-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-235"><a href="#cb15-235" aria-hidden="true" tabindex="-1"></a>To obtain the full joint posterior we will take use key independence assumptions</span>
<span id="cb15-236"><a href="#cb15-236" aria-hidden="true" tabindex="-1"></a>between the parameters of our model. For example, given a group-specific mean </span>
<span id="cb15-237"><a href="#cb15-237" aria-hidden="true" tabindex="-1"></a>$\theta_j$, the corresponding random variables $Y_{i, j}$ depend only on </span>
<span id="cb15-238"><a href="#cb15-238" aria-hidden="true" tabindex="-1"></a>$(\theta_j, \sigma^2)$ and not on $\mu$ or $\tau^2$ (this is implied in Figure </span>
<span id="cb15-239"><a href="#cb15-239" aria-hidden="true" tabindex="-1"></a>8.3).</span>
<span id="cb15-240"><a href="#cb15-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-241"><a href="#cb15-241" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb15-242"><a href="#cb15-242" aria-hidden="true" tabindex="-1"></a>&amp; p(\theta_1, \dots, \theta_m, \mu, \tau^2, \sigma^2 \mid \boldsymbol{y}_1, \dots, \boldsymbol{y}_m) <span class="sc">\\</span></span>
<span id="cb15-243"><a href="#cb15-243" aria-hidden="true" tabindex="-1"></a>\quad&amp;\propto p(\mu, \tau^2, \sigma^2, \mu, \tau^2, \sigma^2) \times p(\boldsymbol{y}_1, \dots, \boldsymbol{y}_m \mid \theta_1, \dots, \theta_m, \mu, \tau^2, \sigma^2) &amp; \text{Bayes' rule} <span class="sc">\\</span></span>
<span id="cb15-244"><a href="#cb15-244" aria-hidden="true" tabindex="-1"></a>&amp;= p(\mu, \tau^2, \sigma^2) \times p(\theta_1, \dots, \theta_m \mid \mu, \tau^2, \sigma^2) \times p(\boldsymbol{y}_1, \dots, \boldsymbol{y}_m \mid \theta_1, \dots, \theta_m, \mu, \tau^2, \sigma^2) &amp; \text{Chain rule} <span class="sc">\\</span></span>
<span id="cb15-245"><a href="#cb15-245" aria-hidden="true" tabindex="-1"></a>&amp;= p(\mu) p(\tau^2) p(\sigma^2) \times p(\theta_1, \dots, \theta_m \mid \mu, \tau^2) \times p(\boldsymbol{y}_1, \dots, \boldsymbol{y}_m \mid \theta_1, \dots, \theta_m, \sigma^2) &amp; \text{Indep.} <span class="sc">\\</span></span>
<span id="cb15-246"><a href="#cb15-246" aria-hidden="true" tabindex="-1"></a>&amp;= p(\mu) p(\tau^2) p(\sigma^2) \times \left<span class="co">[</span><span class="ot"> \prod_{j = 1}^m p(\theta_j \mid \mu, \tau^2) \right</span><span class="co">]</span> \times \left<span class="co">[</span><span class="ot"> \prod_{j = 1}^m p(\boldsymbol{y}_j \mid \theta_j, \sigma^2) \right</span><span class="co">]</span> &amp; \text{de Finetti} <span class="sc">\\</span></span>
<span id="cb15-247"><a href="#cb15-247" aria-hidden="true" tabindex="-1"></a>&amp;= p(\mu) p(\tau^2) p(\sigma^2) \times \left<span class="co">[</span><span class="ot"> \prod_{j = 1}^m p(\theta_j \mid \mu, \tau^2) \right</span><span class="co">]</span> \times \left<span class="co">[</span><span class="ot"> \prod_{j = 1}^m \left( \prod_{i = 1}^{n_j} p(y_{i, j} \mid \theta_j, \sigma^2) \right) \right</span><span class="co">]</span> &amp; \text{de Finetti 2x} <span class="sc">\\</span> </span>
<span id="cb15-248"><a href="#cb15-248" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb15-249"><a href="#cb15-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-250"><a href="#cb15-250" aria-hidden="true" tabindex="-1"></a>Now to evaluate a full conditional, for example that for $\mu$, we take the full posterior and discard all terms that don't depend on $\mu$:</span>
<span id="cb15-251"><a href="#cb15-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-252"><a href="#cb15-252" aria-hidden="true" tabindex="-1"></a>$$p(\mu \mid \theta_1, \dots, \theta_m, \tau^2, \sigma^2, \boldsymbol{y}_1, \dots, \boldsymbol{y}_m) \propto p(\mu) \prod_{j=1}^m p(\theta_j \mid \mu, \tau^2)$$</span>
<span id="cb15-253"><a href="#cb15-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-254"><a href="#cb15-254" aria-hidden="true" tabindex="-1"></a>which in this case looks exactly like a standard one-sample Normal posterior</span>
<span id="cb15-255"><a href="#cb15-255" aria-hidden="true" tabindex="-1"></a>from Chapter 6, so we borrow that result and replace the relevant variables from</span>
<span id="cb15-256"><a href="#cb15-256" aria-hidden="true" tabindex="-1"></a>our priors. We can do this similarly for the other parameters.</span>
<span id="cb15-257"><a href="#cb15-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-258"><a href="#cb15-258" aria-hidden="true" tabindex="-1"></a><span class="fu">### Quantities</span></span>
<span id="cb15-259"><a href="#cb15-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-260"><a href="#cb15-260" aria-hidden="true" tabindex="-1"></a>Since the work is quite tedious, I leave out the derivations for the full</span>
<span id="cb15-261"><a href="#cb15-261" aria-hidden="true" tabindex="-1"></a>conditionals of the parameters. To summarize, given priors</span>
<span id="cb15-262"><a href="#cb15-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-263"><a href="#cb15-263" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb15-264"><a href="#cb15-264" aria-hidden="true" tabindex="-1"></a>\sigma^2 &amp;\sim \text{inverse-gamma}(\nu_0 / 2, \sigma_0^2 \nu_0 / 2) <span class="sc">\\</span></span>
<span id="cb15-265"><a href="#cb15-265" aria-hidden="true" tabindex="-1"></a>\tau^2 &amp;\sim \text{inverse-gamma}(\eta_0 / 2, \tau_0^2 \eta_0 / 2) <span class="sc">\\</span></span>
<span id="cb15-266"><a href="#cb15-266" aria-hidden="true" tabindex="-1"></a>\mu^2 &amp;\sim \mathcal{N}(\mu_0, \gamma_0^2)</span>
<span id="cb15-267"><a href="#cb15-267" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb15-268"><a href="#cb15-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-269"><a href="#cb15-269" aria-hidden="true" tabindex="-1"></a>the full conditionals are</span>
<span id="cb15-270"><a href="#cb15-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-271"><a href="#cb15-271" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb15-272"><a href="#cb15-272" aria-hidden="true" tabindex="-1"></a><span class="sc">\{</span>\mu \mid \theta_1, \dots, \theta_m, \tau^2<span class="sc">\}</span> &amp;\sim \mathcal{N}\left(\frac{m\bar{\theta} / \tau^2 + \mu_0 / \gamma_0^2}{m/\tau^2 + 1 / \gamma_0^2}, \left<span class="co">[</span><span class="ot">m / \tau^2 + 1 / \gamma_0^2 \right</span><span class="co">]</span>^{-1}\right) <span class="sc">\\</span></span>
<span id="cb15-273"><a href="#cb15-273" aria-hidden="true" tabindex="-1"></a><span class="sc">\{</span>\tau^2 \mid \theta_1, \dots, \theta_m, \mu<span class="sc">\}</span> &amp;\sim \text{inverse-gamma}\left(\frac{\eta_0 + m}{2}, \frac{\eta_0\tau_0^2 + \sum_{j = 1}^{m}(\theta_j - \mu)^2}{2} \right) <span class="sc">\\</span></span>
<span id="cb15-274"><a href="#cb15-274" aria-hidden="true" tabindex="-1"></a><span class="sc">\{</span>\theta_j \mid y_{1, j}, \dots, y_{n_{j}, j}, \sigma^2<span class="sc">\}</span> &amp;\sim \mathcal{N}\left(\frac{n_j\bar{y}_j / \sigma^2 + 1 / \tau^2}{n_j / \sigma^2 + 1 / \tau^2}, \left<span class="co">[</span><span class="ot"> n_j / \sigma^2 + 1 / \tau^2 \right</span><span class="co">]</span>^{-1} \right) <span class="sc">\\</span></span>
<span id="cb15-275"><a href="#cb15-275" aria-hidden="true" tabindex="-1"></a><span class="sc">\{</span>\sigma^2 \mid \boldsymbol{\theta}, \boldsymbol{y_1}, \dots, \boldsymbol{y_n}<span class="sc">\}</span> &amp;\sim \text{inverse-gamma}\left(\frac{1}{2}\left<span class="co">[</span><span class="ot"> \nu_0 + \sum_{j = 1}^m n_j\right</span><span class="co">]</span>, \frac{1}{2}\left<span class="co">[</span><span class="ot">\nu_0\sigma_0^2 + \sum_{j = 1}^{m} \left( \sum_{i = 1}^{n_j} (y_{i, j} - \theta)^2 \right) \right</span><span class="co">]</span> \right)</span>
<span id="cb15-276"><a href="#cb15-276" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb15-277"><a href="#cb15-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-278"><a href="#cb15-278" aria-hidden="true" tabindex="-1"></a>It's worth briefly discussing what these values represent. The full conditionals</span>
<span id="cb15-279"><a href="#cb15-279" aria-hidden="true" tabindex="-1"></a>for $\mu$ and $\tau^2$ look like standard normal posteriors. Similarly, the full</span>
<span id="cb15-280"><a href="#cb15-280" aria-hidden="true" tabindex="-1"></a>conditional for $\theta_j$ looks like a normal posterior dependent only on the</span>
<span id="cb15-281"><a href="#cb15-281" aria-hidden="true" tabindex="-1"></a>specific subgroup $\boldsymbol{y}_j$ and the common variance $\sigma^2$. Lastly</span>
<span id="cb15-282"><a href="#cb15-282" aria-hidden="true" tabindex="-1"></a>(and most interestingly), notice that the posterior for $\sigma^2$ looks like a</span>
<span id="cb15-283"><a href="#cb15-283" aria-hidden="true" tabindex="-1"></a>standard inverse gamma posterior which depends on $\sum \sum (y_{i, j} -</span>
<span id="cb15-284"><a href="#cb15-284" aria-hidden="true" tabindex="-1"></a>\theta)^2$ which is the pooled variance across all groups (see also $\sum n_j$).</span>
<span id="cb15-285"><a href="#cb15-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-286"><a href="#cb15-286" aria-hidden="true" tabindex="-1"></a><span class="fu"># Example: Math scores in U.S. public schools</span></span>
<span id="cb15-287"><a href="#cb15-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-288"><a href="#cb15-288" aria-hidden="true" tabindex="-1"></a>We now look at the full dataset of math scores from 100 schools:</span>
<span id="cb15-289"><a href="#cb15-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-290"><a href="#cb15-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-291"><a href="#cb15-291" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE}</span></span>
<span id="cb15-292"><a href="#cb15-292" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb15-293"><a href="#cb15-293" aria-hidden="true" tabindex="-1"></a>school.df <span class="ot">=</span> Y.school.mathscore <span class="sc">%&gt;%</span> as.data.frame <span class="sc">%&gt;%</span> tbl_df</span>
<span id="cb15-294"><a href="#cb15-294" aria-hidden="true" tabindex="-1"></a>meanscore <span class="ot">=</span> school.df <span class="sc">%&gt;%</span></span>
<span id="cb15-295"><a href="#cb15-295" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(school) <span class="sc">%&gt;%</span></span>
<span id="cb15-296"><a href="#cb15-296" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">meanscore =</span> <span class="fu">mean</span>(mathscore)) <span class="sc">%&gt;%</span></span>
<span id="cb15-297"><a href="#cb15-297" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rank =</span> <span class="fu">rank</span>(meanscore))</span>
<span id="cb15-298"><a href="#cb15-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-299"><a href="#cb15-299" aria-hidden="true" tabindex="-1"></a>school.toplot <span class="ot">=</span> school.df <span class="sc">%&gt;%</span></span>
<span id="cb15-300"><a href="#cb15-300" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(meanscore, <span class="at">by =</span> <span class="st">'school'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-301"><a href="#cb15-301" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">minscore =</span> <span class="fu">min</span>(mathscore), <span class="at">maxscore =</span> <span class="fu">max</span>(mathscore))</span>
<span id="cb15-302"><a href="#cb15-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-303"><a href="#cb15-303" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(school.toplot, <span class="fu">aes</span>(<span class="at">x =</span> rank, <span class="at">y =</span> mathscore, <span class="at">group =</span> school)) <span class="sc">+</span></span>
<span id="cb15-304"><a href="#cb15-304" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_summary</span>(<span class="at">fun.ymin =</span> min, <span class="at">fun.ymax =</span> max, <span class="at">fun.y =</span> mean)</span>
<span id="cb15-305"><a href="#cb15-305" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-306"><a href="#cb15-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-307"><a href="#cb15-307" aria-hidden="true" tabindex="-1"></a><span class="fu">## Prior distributions and posterior approximation</span></span>
<span id="cb15-308"><a href="#cb15-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-309"><a href="#cb15-309" aria-hidden="true" tabindex="-1"></a>We need to specify the following priors:</span>
<span id="cb15-310"><a href="#cb15-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-311"><a href="#cb15-311" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-312"><a href="#cb15-312" aria-hidden="true" tabindex="-1"></a>\sigma^2 \sim \text{inverse-gamma}(\nu_0 / 2, \sigma_0^2 \nu_0 / 2)</span>
<span id="cb15-313"><a href="#cb15-313" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-314"><a href="#cb15-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-315"><a href="#cb15-315" aria-hidden="true" tabindex="-1"></a>If we know the math exam was designed to give a nationwide variance of 100, we </span>
<span id="cb15-316"><a href="#cb15-316" aria-hidden="true" tabindex="-1"></a>can set the within-school variance to 100. This is probably an overestimate </span>
<span id="cb15-317"><a href="#cb15-317" aria-hidden="true" tabindex="-1"></a>since the within-school variance should be less than the nationwide estimate. </span>
<span id="cb15-318"><a href="#cb15-318" aria-hidden="true" tabindex="-1"></a>Regardless, we set $\sigma_0^2 = 100, \nu_0 = 1$ to weakly concentrate the prior</span>
<span id="cb15-319"><a href="#cb15-319" aria-hidden="true" tabindex="-1"></a>around 100.</span>
<span id="cb15-320"><a href="#cb15-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-321"><a href="#cb15-321" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-322"><a href="#cb15-322" aria-hidden="true" tabindex="-1"></a>\tau^2 \sim \text{inverse-gamma}(\eta_0 / 2, \tau_0^2 \eta_0 / 2)</span>
<span id="cb15-323"><a href="#cb15-323" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-324"><a href="#cb15-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-325"><a href="#cb15-325" aria-hidden="true" tabindex="-1"></a>Similarly, we set $\tau_0^2 = 100, \eta_0 = 1$.</span>
<span id="cb15-326"><a href="#cb15-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-327"><a href="#cb15-327" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-328"><a href="#cb15-328" aria-hidden="true" tabindex="-1"></a>\mu^2 \sim \mathcal{N}(\mu_0, \gamma_0^2)</span>
<span id="cb15-329"><a href="#cb15-329" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-330"><a href="#cb15-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-331"><a href="#cb15-331" aria-hidden="true" tabindex="-1"></a>Since the mean over all schools should be 50, we set $\mu_0 = 50, \gamma_0^2 = 25$, so that 95% of the probability of our prior is in $(40, 60)$.</span>
<span id="cb15-332"><a href="#cb15-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-333"><a href="#cb15-333" aria-hidden="true" tabindex="-1"></a><span class="fu">### Gibbs sampling</span></span>
<span id="cb15-334"><a href="#cb15-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-335"><a href="#cb15-335" aria-hidden="true" tabindex="-1"></a>Now that we're sampling more and more parameters $<span class="sc">\{</span>\mu^{(s)}, \tau^{2(s)},</span>
<span id="cb15-336"><a href="#cb15-336" aria-hidden="true" tabindex="-1"></a>\sigma^{2(s)}, \theta_1^{(s)}, \dots, \theta_m^{(s)} <span class="sc">\}</span>$, there's a key point</span>
<span id="cb15-337"><a href="#cb15-337" aria-hidden="true" tabindex="-1"></a>about Gibbs sampling that must be emphasized: the order in which we sample the</span>
<span id="cb15-338"><a href="#cb15-338" aria-hidden="true" tabindex="-1"></a>new parameters doesn't matter, but each parameter must be updated according to</span>
<span id="cb15-339"><a href="#cb15-339" aria-hidden="true" tabindex="-1"></a>the *most current* values of the other parameters. That is, if we have sampled</span>
<span id="cb15-340"><a href="#cb15-340" aria-hidden="true" tabindex="-1"></a>$\mu^{(s+1)}$, the sample of $\tau^{(s + 1)}$ must be dependent on</span>
<span id="cb15-341"><a href="#cb15-341" aria-hidden="true" tabindex="-1"></a>$\mu^{(s+1)}$, **NOT** $\mu^{(s)}$. This ensures the markov chain property.</span>
<span id="cb15-342"><a href="#cb15-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-345"><a href="#cb15-345" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb15-346"><a href="#cb15-346" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">=</span> Y.school.mathscore</span>
<span id="cb15-347"><a href="#cb15-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-348"><a href="#cb15-348" aria-hidden="true" tabindex="-1"></a><span class="co"># Priors</span></span>
<span id="cb15-349"><a href="#cb15-349" aria-hidden="true" tabindex="-1"></a>nu0 <span class="ot">=</span> eta0 <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb15-350"><a href="#cb15-350" aria-hidden="true" tabindex="-1"></a>s20 <span class="ot">=</span> t20 <span class="ot">=</span> <span class="dv">100</span></span>
<span id="cb15-351"><a href="#cb15-351" aria-hidden="true" tabindex="-1"></a>mu0 <span class="ot">=</span> <span class="dv">50</span></span>
<span id="cb15-352"><a href="#cb15-352" aria-hidden="true" tabindex="-1"></a>g20 <span class="ot">=</span> <span class="dv">25</span></span>
<span id="cb15-353"><a href="#cb15-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-354"><a href="#cb15-354" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of schools. Y[, 1] are school ids</span></span>
<span id="cb15-355"><a href="#cb15-355" aria-hidden="true" tabindex="-1"></a>m <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(Y[, <span class="dv">1</span>]))</span>
<span id="cb15-356"><a href="#cb15-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-357"><a href="#cb15-357" aria-hidden="true" tabindex="-1"></a><span class="co"># Starting values - use sample mean and variance</span></span>
<span id="cb15-358"><a href="#cb15-358" aria-hidden="true" tabindex="-1"></a>n <span class="ot">=</span> sv <span class="ot">=</span> ybar <span class="ot">=</span> <span class="fu">rep</span>(<span class="cn">NA</span>, m)</span>
<span id="cb15-359"><a href="#cb15-359" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>m) {</span>
<span id="cb15-360"><a href="#cb15-360" aria-hidden="true" tabindex="-1"></a>  Y_j <span class="ot">=</span> Y[Y[, <span class="dv">1</span>] <span class="sc">==</span> j, <span class="dv">2</span>]</span>
<span id="cb15-361"><a href="#cb15-361" aria-hidden="true" tabindex="-1"></a>  ybar[j] <span class="ot">=</span> <span class="fu">mean</span>(Y_j)</span>
<span id="cb15-362"><a href="#cb15-362" aria-hidden="true" tabindex="-1"></a>  sv[j] <span class="ot">=</span> <span class="fu">var</span>(Y_j)</span>
<span id="cb15-363"><a href="#cb15-363" aria-hidden="true" tabindex="-1"></a>  n[j] <span class="ot">=</span> <span class="fu">length</span>(Y_j)</span>
<span id="cb15-364"><a href="#cb15-364" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-365"><a href="#cb15-365" aria-hidden="true" tabindex="-1"></a><span class="co"># Let initial theta estimates be the sample means</span></span>
<span id="cb15-366"><a href="#cb15-366" aria-hidden="true" tabindex="-1"></a><span class="co"># Similarly, let initial values of sigma2, mu, and tau2 be "sample mean and</span></span>
<span id="cb15-367"><a href="#cb15-367" aria-hidden="true" tabindex="-1"></a><span class="co"># variance"</span></span>
<span id="cb15-368"><a href="#cb15-368" aria-hidden="true" tabindex="-1"></a>theta <span class="ot">=</span> ybar</span>
<span id="cb15-369"><a href="#cb15-369" aria-hidden="true" tabindex="-1"></a>sigma2 <span class="ot">=</span> <span class="fu">mean</span>(sv)</span>
<span id="cb15-370"><a href="#cb15-370" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">=</span> <span class="fu">mean</span>(theta)</span>
<span id="cb15-371"><a href="#cb15-371" aria-hidden="true" tabindex="-1"></a>tau2 <span class="ot">=</span> <span class="fu">var</span>(theta)</span>
<span id="cb15-372"><a href="#cb15-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-373"><a href="#cb15-373" aria-hidden="true" tabindex="-1"></a><span class="co"># MCMC</span></span>
<span id="cb15-374"><a href="#cb15-374" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb15-375"><a href="#cb15-375" aria-hidden="true" tabindex="-1"></a>S <span class="ot">=</span> <span class="dv">1000</span></span>
<span id="cb15-376"><a href="#cb15-376" aria-hidden="true" tabindex="-1"></a>THETA <span class="ot">=</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> S, <span class="at">ncol =</span> m)</span>
<span id="cb15-377"><a href="#cb15-377" aria-hidden="true" tabindex="-1"></a><span class="co"># Storing sigma, mu, theta together</span></span>
<span id="cb15-378"><a href="#cb15-378" aria-hidden="true" tabindex="-1"></a>SMT <span class="ot">=</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> S, <span class="at">ncol =</span> <span class="dv">3</span>)</span>
<span id="cb15-379"><a href="#cb15-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-380"><a href="#cb15-380" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (s <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>S) {</span>
<span id="cb15-381"><a href="#cb15-381" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sample thetas</span></span>
<span id="cb15-382"><a href="#cb15-382" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>m) {</span>
<span id="cb15-383"><a href="#cb15-383" aria-hidden="true" tabindex="-1"></a>    vtheta <span class="ot">=</span> <span class="dv">1</span> <span class="sc">/</span> (n[j] <span class="sc">/</span> sigma2 <span class="sc">+</span> <span class="dv">1</span> <span class="sc">/</span> tau2)</span>
<span id="cb15-384"><a href="#cb15-384" aria-hidden="true" tabindex="-1"></a>    etheta <span class="ot">=</span> vtheta <span class="sc">*</span> (ybar[j] <span class="sc">*</span> n[j] <span class="sc">/</span> sigma2 <span class="sc">+</span> mu <span class="sc">/</span> tau2)</span>
<span id="cb15-385"><a href="#cb15-385" aria-hidden="true" tabindex="-1"></a>    theta[j] <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, etheta, <span class="fu">sqrt</span>(vtheta))</span>
<span id="cb15-386"><a href="#cb15-386" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-387"><a href="#cb15-387" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-388"><a href="#cb15-388" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sample sigma2</span></span>
<span id="cb15-389"><a href="#cb15-389" aria-hidden="true" tabindex="-1"></a>  nun <span class="ot">=</span> nu0 <span class="sc">+</span> <span class="fu">sum</span>(n) <span class="co"># </span><span class="al">TODO</span><span class="co">: Could cache this</span></span>
<span id="cb15-390"><a href="#cb15-390" aria-hidden="true" tabindex="-1"></a>  ss <span class="ot">=</span> nu0 <span class="sc">*</span> s20</span>
<span id="cb15-391"><a href="#cb15-391" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Pool variance</span></span>
<span id="cb15-392"><a href="#cb15-392" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>m) {</span>
<span id="cb15-393"><a href="#cb15-393" aria-hidden="true" tabindex="-1"></a>    ss <span class="ot">=</span> ss <span class="sc">+</span> <span class="fu">sum</span>((Y[Y[, <span class="dv">1</span>] <span class="sc">==</span> j, <span class="dv">2</span>] <span class="sc">-</span> theta[j])<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb15-394"><a href="#cb15-394" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-395"><a href="#cb15-395" aria-hidden="true" tabindex="-1"></a>  sigma2 <span class="ot">=</span> <span class="dv">1</span> <span class="sc">/</span> <span class="fu">rgamma</span>(<span class="dv">1</span>, nun <span class="sc">/</span> <span class="dv">2</span>, ss <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb15-396"><a href="#cb15-396" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-397"><a href="#cb15-397" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sample mu</span></span>
<span id="cb15-398"><a href="#cb15-398" aria-hidden="true" tabindex="-1"></a>  vmu <span class="ot">=</span> <span class="dv">1</span> <span class="sc">/</span> (m <span class="sc">/</span> tau2 <span class="sc">+</span> <span class="dv">1</span> <span class="sc">/</span>g20)</span>
<span id="cb15-399"><a href="#cb15-399" aria-hidden="true" tabindex="-1"></a>  emu <span class="ot">=</span> vmu <span class="sc">*</span> (m <span class="sc">*</span> <span class="fu">mean</span>(theta) <span class="sc">/</span> tau2 <span class="sc">+</span> mu0 <span class="sc">/</span> g20)</span>
<span id="cb15-400"><a href="#cb15-400" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, emu, <span class="fu">sqrt</span>(vmu))</span>
<span id="cb15-401"><a href="#cb15-401" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-402"><a href="#cb15-402" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sample tau2</span></span>
<span id="cb15-403"><a href="#cb15-403" aria-hidden="true" tabindex="-1"></a>  etam <span class="ot">=</span> eta0 <span class="sc">+</span> m</span>
<span id="cb15-404"><a href="#cb15-404" aria-hidden="true" tabindex="-1"></a>  ss <span class="ot">=</span> eta0 <span class="sc">*</span> t20 <span class="sc">+</span> <span class="fu">sum</span>((theta <span class="sc">-</span> mu)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb15-405"><a href="#cb15-405" aria-hidden="true" tabindex="-1"></a>  tau2 <span class="ot">=</span> <span class="dv">1</span> <span class="sc">/</span> <span class="fu">rgamma</span>(<span class="dv">1</span>, etam <span class="sc">/</span> <span class="dv">2</span>, ss <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb15-406"><a href="#cb15-406" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-407"><a href="#cb15-407" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Store params</span></span>
<span id="cb15-408"><a href="#cb15-408" aria-hidden="true" tabindex="-1"></a>  THETA[s, ] <span class="ot">=</span> theta</span>
<span id="cb15-409"><a href="#cb15-409" aria-hidden="true" tabindex="-1"></a>  SMT[s, ] <span class="ot">=</span> <span class="fu">c</span>(sigma2, mu, tau2)</span>
<span id="cb15-410"><a href="#cb15-410" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-411"><a href="#cb15-411" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-412"><a href="#cb15-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-413"><a href="#cb15-413" aria-hidden="true" tabindex="-1"></a><span class="fu">### MCMC diagnostics</span></span>
<span id="cb15-414"><a href="#cb15-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-415"><a href="#cb15-415" aria-hidden="true" tabindex="-1"></a>The book mentions here that it's important to check convergence of the Gibbs </span>
<span id="cb15-416"><a href="#cb15-416" aria-hidden="true" tabindex="-1"></a>sampler; I won't do that here, but dividing the samples into groups of e.g. 500 </span>
<span id="cb15-417"><a href="#cb15-417" aria-hidden="true" tabindex="-1"></a>samples, and ensuring that the mean values of the parameters don't change too</span>
<span id="cb15-418"><a href="#cb15-418" aria-hidden="true" tabindex="-1"></a>much from group to group is a good way to check, at least for a manageable</span>
<span id="cb15-419"><a href="#cb15-419" aria-hidden="true" tabindex="-1"></a>number of parameters.</span>
<span id="cb15-420"><a href="#cb15-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-421"><a href="#cb15-421" aria-hidden="true" tabindex="-1"></a><span class="fu">## Posterior summaries and shrinkage</span></span>
<span id="cb15-422"><a href="#cb15-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-423"><a href="#cb15-423" aria-hidden="true" tabindex="-1"></a>Notice from the full conditional of $\theta_j$ above that the expected value of $\theta_j$ is a weighted average of $\bar{y}_j$ and $\mu$:</span>
<span id="cb15-424"><a href="#cb15-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-425"><a href="#cb15-425" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb15-426"><a href="#cb15-426" aria-hidden="true" tabindex="-1"></a>\mathbb{E}(\theta_j \mid \boldsymbol{y}_j, \mu, \tau^2, \sigma^2) &amp;= \frac{\bar{y}_j n_j / \sigma^2 + \mu/\tau^2}{n_j / \sigma^2 + 1 / \tau^2} <span class="sc">\\</span></span>
<span id="cb15-427"><a href="#cb15-427" aria-hidden="true" tabindex="-1"></a>&amp;= \frac{n_j / \sigma^2}{n_j / \sigma^2 + 1 / \tau^2} \bar{y}_j + \frac{1 / \tau^2}{n_j / \sigma^2 + 1 / \tau^2} \mu</span>
<span id="cb15-428"><a href="#cb15-428" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb15-429"><a href="#cb15-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-430"><a href="#cb15-430" aria-hidden="true" tabindex="-1"></a>which is specifically weighted by the sample size $n_j$. Since we assume that </span>
<span id="cb15-431"><a href="#cb15-431" aria-hidden="true" tabindex="-1"></a>there is some common mean $\mu$, our estimate of $\theta_j$ gets pulled slightly</span>
<span id="cb15-432"><a href="#cb15-432" aria-hidden="true" tabindex="-1"></a>towards that common parameter $\mu$ - less so for high $n_j$. This demonstrates </span>
<span id="cb15-433"><a href="#cb15-433" aria-hidden="true" tabindex="-1"></a>the phonemonon of *shrinkage*, where information is shared across groups in this</span>
<span id="cb15-434"><a href="#cb15-434" aria-hidden="true" tabindex="-1"></a>hierarchical model.</span>
<span id="cb15-435"><a href="#cb15-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-436"><a href="#cb15-436" aria-hidden="true" tabindex="-1"></a>Again, for high $n_j$, however, the effect of this shrinkage is neglegible.</span>
<span id="cb15-437"><a href="#cb15-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-438"><a href="#cb15-438" aria-hidden="true" tabindex="-1"></a>Shrinkage results in some interesting phenomena. For example, look at schools 82</span>
<span id="cb15-439"><a href="#cb15-439" aria-hidden="true" tabindex="-1"></a>and 46 in our dataset.</span>
<span id="cb15-440"><a href="#cb15-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-441"><a href="#cb15-441" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo}</span></span>
<span id="cb15-442"><a href="#cb15-442" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(THETA[, <span class="dv">82</span>])</span>
<span id="cb15-443"><a href="#cb15-443" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(THETA[, <span class="dv">46</span>])</span>
<span id="cb15-444"><a href="#cb15-444" aria-hidden="true" tabindex="-1"></a>ybar[<span class="dv">82</span>]</span>
<span id="cb15-445"><a href="#cb15-445" aria-hidden="true" tabindex="-1"></a>ybar[<span class="dv">46</span>]</span>
<span id="cb15-446"><a href="#cb15-446" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-447"><a href="#cb15-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-448"><a href="#cb15-448" aria-hidden="true" tabindex="-1"></a>Even though the sample mean of school 82 is lower than school 46, the posterior</span>
<span id="cb15-449"><a href="#cb15-449" aria-hidden="true" tabindex="-1"></a>expectation of $\theta_{82}$ is *higher* than $\theta_{46}$, because school 82 has a</span>
<span id="cb15-450"><a href="#cb15-450" aria-hidden="true" tabindex="-1"></a>very small sample and thus is affected more by a pull towards $\mu$. While this</span>
<span id="cb15-451"><a href="#cb15-451" aria-hidden="true" tabindex="-1"></a>may seem counterintuitive, the explanation is that there is more evidence that</span>
<span id="cb15-452"><a href="#cb15-452" aria-hidden="true" tabindex="-1"></a>$\theta_{46}$ is low than there is $\theta_{82}$ is low due to the wide</span>
<span id="cb15-453"><a href="#cb15-453" aria-hidden="true" tabindex="-1"></a>discrepancy in sample sizes. The assumption that $\theta_j$ stem from one $\mu$,</span>
<span id="cb15-454"><a href="#cb15-454" aria-hidden="true" tabindex="-1"></a>then, takes a "conservative" approach to estimating the $\theta_{82}$ with</span>
<span id="cb15-455"><a href="#cb15-455" aria-hidden="true" tabindex="-1"></a>little data.</span>
<span id="cb15-456"><a href="#cb15-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-457"><a href="#cb15-457" aria-hidden="true" tabindex="-1"></a><span class="fu"># Hierarchical modeling of means and variances</span></span>
<span id="cb15-458"><a href="#cb15-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-459"><a href="#cb15-459" aria-hidden="true" tabindex="-1"></a>The previous model assumed common variance within groups $\sigma^2$. This is </span>
<span id="cb15-460"><a href="#cb15-460" aria-hidden="true" tabindex="-1"></a>actually fairly common, perhaps less because of empirical justification for </span>
<span id="cb15-461"><a href="#cb15-461" aria-hidden="true" tabindex="-1"></a>assuming common within-group variance than lack of interest in the variance of </span>
<span id="cb15-462"><a href="#cb15-462" aria-hidden="true" tabindex="-1"></a>the groups. But of course, the inaccuracy of this assumption could result in </span>
<span id="cb15-463"><a href="#cb15-463" aria-hidden="true" tabindex="-1"></a>errors in analysis. It's fairly straightforward to simply add another </span>
<span id="cb15-464"><a href="#cb15-464" aria-hidden="true" tabindex="-1"></a>hierarchical layer for the variance too, and jointly estimate the group-specific</span>
<span id="cb15-465"><a href="#cb15-465" aria-hidden="true" tabindex="-1"></a>means and variances, as well as the common mean and variance parameters.</span>
<span id="cb15-466"><a href="#cb15-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-467"><a href="#cb15-467" aria-hidden="true" tabindex="-1"></a>To implement this, we let $\theta_j$ depend on $\boldsymbol{y}_j$ and (new!) a</span>
<span id="cb15-468"><a href="#cb15-468" aria-hidden="true" tabindex="-1"></a>group $j$-specific $\sigma_j^2$, so our full conditional distribution is</span>
<span id="cb15-469"><a href="#cb15-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-470"><a href="#cb15-470" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-471"><a href="#cb15-471" aria-hidden="true" tabindex="-1"></a>\theta_j \mid \boldsymbol{y}_j, \sigma_j^2 \sim \mathcal{N}\left( \frac{n_j\bar{y}_j / \sigma_j^2 + 1 / \tau^2}{n_j / \sigma_j^2 + 1 / \tau^2}, \left<span class="co">[</span><span class="ot">n_j / \sigma_j^2 + 1 / \tau^2 \right</span><span class="co">]</span>^{-1} \right)</span>
<span id="cb15-472"><a href="#cb15-472" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-473"><a href="#cb15-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-474"><a href="#cb15-474" aria-hidden="true" tabindex="-1"></a>similarly, above we had a rather special case of the full conditional of</span>
<span id="cb15-475"><a href="#cb15-475" aria-hidden="true" tabindex="-1"></a>$\sigma^2$. Since there was one common $\sigma^2$, the posterior was based on a </span>
<span id="cb15-476"><a href="#cb15-476" aria-hidden="true" tabindex="-1"></a>combination of the prior precision and the pooled sample variance. Now let's </span>
<span id="cb15-477"><a href="#cb15-477" aria-hidden="true" tabindex="-1"></a>assume that we have a separate $\sigma_j^2$ for each group:</span>
<span id="cb15-478"><a href="#cb15-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-479"><a href="#cb15-479" aria-hidden="true" tabindex="-1"></a>$$\sigma_1^2, \dots, \sigma_m^2 \sim  \text{i.i.d.} \; \mathcal{N}(\nu_0 / 2, \sigma_0^2 \nu_0 / 2).$$</span>
<span id="cb15-480"><a href="#cb15-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-481"><a href="#cb15-481" aria-hidden="true" tabindex="-1"></a>Now that we're including individual $\sigma_j^2$, re-deriving the full</span>
<span id="cb15-482"><a href="#cb15-482" aria-hidden="true" tabindex="-1"></a>conditional for $\sigma_j^2$ results in full conditional distributions that look</span>
<span id="cb15-483"><a href="#cb15-483" aria-hidden="true" tabindex="-1"></a>just like the one-parameter case for variance (and the corresponding $\theta_j$ conditionals for the means):</span>
<span id="cb15-484"><a href="#cb15-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-485"><a href="#cb15-485" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-486"><a href="#cb15-486" aria-hidden="true" tabindex="-1"></a>\sigma_j^2 \mid \boldsymbol{y}_j, \theta_j \sim \text{inverse-gamma}\left([\nu_0 - n_j] / 2, \left[\nu_0 \sigma_0^2 + \sum_{i = 1}^{n_j}(y_{i, j} - \theta_j)^2 \right] / 2 \right)</span>
<span id="cb15-487"><a href="#cb15-487" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-488"><a href="#cb15-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-489"><a href="#cb15-489" aria-hidden="true" tabindex="-1"></a>Now in the same way that we learn the group-specific parameters $\mu, \tau^2$ </span>
<span id="cb15-490"><a href="#cb15-490" aria-hidden="true" tabindex="-1"></a>using prior distributions with hyperparameters $\eta_0, \tau_0^2, \mu_0, </span>
<span id="cb15-491"><a href="#cb15-491" aria-hidden="true" tabindex="-1"></a>\gamma_0^2$, we should learn $\nu_0, \sigma_0^2$ with prior distributions.</span>
<span id="cb15-492"><a href="#cb15-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-493"><a href="#cb15-493" aria-hidden="true" tabindex="-1"></a>Since we are modeling variances, we let $\sigma_0^2 \sim \text{gamma}(a, b)$ such that the posterior is</span>
<span id="cb15-494"><a href="#cb15-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-495"><a href="#cb15-495" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-496"><a href="#cb15-496" aria-hidden="true" tabindex="-1"></a>\sigma_0^2 \mid \sigma_1^2, \dots, \sigma_m^2, \nu_0 \sim \text{gamma}\left(a + \frac{1}{2}m \nu_0, b + \frac{1}{2}\sum_{j = 1}^m (1 / \sigma_j^2)\right)</span>
<span id="cb15-497"><a href="#cb15-497" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-498"><a href="#cb15-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-499"><a href="#cb15-499" aria-hidden="true" tabindex="-1"></a>Lastly, there is no simple conjugate prior for $\nu_0$ unless we restrict</span>
<span id="cb15-500"><a href="#cb15-500" aria-hidden="true" tabindex="-1"></a>$\nu_0$ to be a whole number. If we let $\nu_0 \sim \text{geometric}(\alpha)$,</span>
<span id="cb15-501"><a href="#cb15-501" aria-hidden="true" tabindex="-1"></a>then (as the discrete analog of the exponential distribution) $p(\nu_0) \sim</span>
<span id="cb15-502"><a href="#cb15-502" aria-hidden="true" tabindex="-1"></a>\text{exp}(-\alpha \nu_0)$ and the full conditional distribution of $\nu_0$ can be shown to be</span>
<span id="cb15-503"><a href="#cb15-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-504"><a href="#cb15-504" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-505"><a href="#cb15-505" aria-hidden="true" tabindex="-1"></a>p(\nu_0 \mid \sigma_0^2, \dots, \sigma_m^2) \propto \left( \frac{(\sigma_0^2 \nu_0 / 2)^{\nu_0 / 2}}{\Gamma(\nu_0 / 2)} \right)^m \left( \prod_{j = 1}^m \frac{1}{\sigma_j^2} \right)^{\nu_0 / 2 - 1} \times \text{exp} \left( - \nu_0 \left(\alpha + \frac{1}{2} \sigma_0^2 \sum_{j = 1}^m \frac{1}{\sigma_j^2} \right) \right)</span>
<span id="cb15-506"><a href="#cb15-506" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb15-507"><a href="#cb15-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-508"><a href="#cb15-508" aria-hidden="true" tabindex="-1"></a><span class="fu">## Analysis of math score data</span></span>
<span id="cb15-509"><a href="#cb15-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-510"><a href="#cb15-510" aria-hidden="true" tabindex="-1"></a>For time I haven't reproduced the analysis here are there aren't too many</span>
<span id="cb15-511"><a href="#cb15-511" aria-hidden="true" tabindex="-1"></a>conclusions drawn - the point is just that you can let the variance vary across</span>
<span id="cb15-512"><a href="#cb15-512" aria-hidden="true" tabindex="-1"></a>groups.</span>
<span id="cb15-513"><a href="#cb15-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-514"><a href="#cb15-514" aria-hidden="true" tabindex="-1"></a><span class="fu"># Exercises</span></span>
<span id="cb15-515"><a href="#cb15-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-516"><a href="#cb15-516" aria-hidden="true" tabindex="-1"></a><span class="fu">## 8.1</span></span>
<span id="cb15-517"><a href="#cb15-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-518"><a href="#cb15-518" aria-hidden="true" tabindex="-1"></a><span class="fu">### a</span></span>
<span id="cb15-519"><a href="#cb15-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-520"><a href="#cb15-520" aria-hidden="true" tabindex="-1"></a>I expect $\text{Var}(y_{i, j} \mid \mu, \tau^2)$ to be bigger since it includes</span>
<span id="cb15-521"><a href="#cb15-521" aria-hidden="true" tabindex="-1"></a>both within- and between-group sampling variability.</span>
<span id="cb15-522"><a href="#cb15-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-523"><a href="#cb15-523" aria-hidden="true" tabindex="-1"></a><span class="fu">### b</span></span>
<span id="cb15-524"><a href="#cb15-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-525"><a href="#cb15-525" aria-hidden="true" tabindex="-1"></a>I think $\text{Cov}(y_{i_1, j}, y_{i_2, j} \mid \theta_j, \sigma^2)$ is zero</span>
<span id="cb15-526"><a href="#cb15-526" aria-hidden="true" tabindex="-1"></a>because, according to exchangeability, our $y_{i, j}$ are conditionally i.i.d.</span>
<span id="cb15-527"><a href="#cb15-527" aria-hidden="true" tabindex="-1"></a>when $\theta_j, \sigma^2$ is known.</span>
<span id="cb15-528"><a href="#cb15-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-529"><a href="#cb15-529" aria-hidden="true" tabindex="-1"></a>On the other hand, given our model, it seems like knowing about another $y_{i_1,</span>
<span id="cb15-530"><a href="#cb15-530" aria-hidden="true" tabindex="-1"></a>j}$ *does* provide more information about $y_{i_2, j}$, and I expect them to</span>
<span id="cb15-531"><a href="#cb15-531" aria-hidden="true" tabindex="-1"></a>covary positively with each other. Specifically, $y_{i_1, j}$ seems to give more</span>
<span id="cb15-532"><a href="#cb15-532" aria-hidden="true" tabindex="-1"></a>information about what the mean $\theta_j$ is, and we expect values from the</span>
<span id="cb15-533"><a href="#cb15-533" aria-hidden="true" tabindex="-1"></a>same $\theta_j$ to be closer together (due to decreased variability). I can't</span>
<span id="cb15-534"><a href="#cb15-534" aria-hidden="true" tabindex="-1"></a>come up with a more formal mathematical justification, though.</span>
<span id="cb15-535"><a href="#cb15-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-536"><a href="#cb15-536" aria-hidden="true" tabindex="-1"></a><span class="fu">### c</span></span>
<span id="cb15-537"><a href="#cb15-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-538"><a href="#cb15-538" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb15-539"><a href="#cb15-539" aria-hidden="true" tabindex="-1"></a>\text{Var}(y_{i, j} \mid \theta_j, \sigma^2) &amp;= \sigma^2 &amp; \text{By def.}<span class="sc">\\</span></span>
<span id="cb15-540"><a href="#cb15-540" aria-hidden="true" tabindex="-1"></a>\text{Var}(\bar{y}_{\cdot, j} \mid \theta_j, \sigma^2) &amp;= \sigma^2 / n_j &amp; \text{Samp. dist. mean} <span class="sc">\\</span></span>
<span id="cb15-541"><a href="#cb15-541" aria-hidden="true" tabindex="-1"></a>\text{Cov}(y_{i_1, j}, y_{i_2, j} \mid \theta_j, \sigma^2) &amp;= \mathbb{E}(y_{i_1, j}y_{i_2, j}) - \mathbb{E}(y_{i_1, j})\mathbb{E}(y_{i_2, j}) <span class="sc">\\</span></span>
<span id="cb15-542"><a href="#cb15-542" aria-hidden="true" tabindex="-1"></a>&amp;= \mathbb{E}(y_{i_1, j})\mathbb{E}(y_{i_2, j}) - \mathbb{E}(y_{i_1, j})\mathbb{E}(y_{i_2, j}) &amp; \text{i.i.d.} <span class="sc">\\</span></span>
<span id="cb15-543"><a href="#cb15-543" aria-hidden="true" tabindex="-1"></a>&amp;= 0 <span class="sc">\\</span></span>
<span id="cb15-544"><a href="#cb15-544" aria-hidden="true" tabindex="-1"></a>&amp; <span class="sc">\\</span></span>
<span id="cb15-545"><a href="#cb15-545" aria-hidden="true" tabindex="-1"></a>\text{Var}(y_{i, j} \mid \mu, \tau^2) &amp;= \text{Var}(\mathbb{E}(y_{i, j} \mid \theta_j, \sigma^2) \mid \mu, \tau^2) + \mathbb{E}(\text{Var}(y_{i, j} \mid \theta_j, \sigma^2) \mid \mu, \tau^2) &amp; \text{Law total var.} <span class="sc">\\</span></span>
<span id="cb15-546"><a href="#cb15-546" aria-hidden="true" tabindex="-1"></a>&amp;= \text{Var}(\theta_j \mid \mu, \tau^2) + \mathbb{E}(\sigma^2 \mid \mu, \tau^2) <span class="sc">\\</span></span>
<span id="cb15-547"><a href="#cb15-547" aria-hidden="true" tabindex="-1"></a>&amp;= \tau^2 + \sigma^2 <span class="sc">\\</span></span>
<span id="cb15-548"><a href="#cb15-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-549"><a href="#cb15-549" aria-hidden="true" tabindex="-1"></a>\text{Var}(\bar{y}_{\cdot, j} \mid \mu, \tau^2) &amp;= \text{Var}(\mathbb{E}(\bar{y}_{\cdot, j} \mid \theta_j, \sigma^2) \mid \mu, \tau^2) + \mathbb{E}(\text{Var}(\bar{y}_{\cdot, j} \mid \theta_j, \sigma^2) \mid \mu, \tau^2) &amp; \text{Law total var.} <span class="sc">\\</span></span>
<span id="cb15-550"><a href="#cb15-550" aria-hidden="true" tabindex="-1"></a>&amp;= \text{Var}(\theta_j \mid \mu, \tau^2) + \mathbb{E}(\sigma^2 / n_j \mid \mu, \tau^2) <span class="sc">\\</span></span>
<span id="cb15-551"><a href="#cb15-551" aria-hidden="true" tabindex="-1"></a>&amp;= \tau^2 + (\sigma^2 / n_j) <span class="sc">\\</span></span>
<span id="cb15-552"><a href="#cb15-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-553"><a href="#cb15-553" aria-hidden="true" tabindex="-1"></a>\text{Cov}(y_{i_1, j}, y_{i_2, j} \mid \mu, \tau^2) &amp;= \text{E}(\text{Cov}(y_{i_1, j}, y_{i_2, j} \mid \theta_j, \sigma^2) \mid \mu, \tau^2) + \text{Cov}(\mathbb{E}(y_{i_1, j} \mid \theta_j, \sigma^2), \mathbb{E}(y_{i_2, j} \mid \theta_j, \sigma^2)) &amp; \text{Law total covar.} <span class="sc">\\</span></span>
<span id="cb15-554"><a href="#cb15-554" aria-hidden="true" tabindex="-1"></a>&amp;= \text{E}(0 \mid \mu, \tau^2) + \text{Cov}(\mathbb{E}(y_{i_1, j} \mid \theta_j, \sigma^2), \mathbb{E}(y_{i_2, j} \mid \theta_j, \sigma^2)) &amp; \text{i.i.d.} <span class="sc">\\</span></span>
<span id="cb15-555"><a href="#cb15-555" aria-hidden="true" tabindex="-1"></a>&amp;= \text{Cov}(\theta_j, \theta_j) <span class="sc">\\</span></span>
<span id="cb15-556"><a href="#cb15-556" aria-hidden="true" tabindex="-1"></a>&amp;= \text{Var}(\theta_j) <span class="sc">\\</span></span>
<span id="cb15-557"><a href="#cb15-557" aria-hidden="true" tabindex="-1"></a>&amp;= \tau^2</span>
<span id="cb15-558"><a href="#cb15-558" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb15-559"><a href="#cb15-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-560"><a href="#cb15-560" aria-hidden="true" tabindex="-1"></a>These values indeed align with the intuitions above. The values for the</span>
<span id="cb15-561"><a href="#cb15-561" aria-hidden="true" tabindex="-1"></a>variances and covariances with $\theta_j$ unknown are simply those for</span>
<span id="cb15-562"><a href="#cb15-562" aria-hidden="true" tabindex="-1"></a>$\theta_j$ known plus $\tau^2$, the between-group sampling variability.</span>
<span id="cb15-563"><a href="#cb15-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-564"><a href="#cb15-564" aria-hidden="true" tabindex="-1"></a><span class="fu">### d</span></span>
<span id="cb15-565"><a href="#cb15-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-566"><a href="#cb15-566" aria-hidden="true" tabindex="-1"></a>For convenience let $\mathcal{D} = <span class="sc">\{</span>\boldsymbol{y}_1, \dots,</span>
<span id="cb15-567"><a href="#cb15-567" aria-hidden="true" tabindex="-1"></a>\boldsymbol{y}_m<span class="sc">\}</span>$ and $\boldsymbol{\theta} = <span class="sc">\{</span> \theta_1, \dots, \theta_m <span class="sc">\}</span>$.</span>
<span id="cb15-568"><a href="#cb15-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-569"><a href="#cb15-569" aria-hidden="true" tabindex="-1"></a>Also, if we treat the model as a Bayes' net, we can use factorization to quickly</span>
<span id="cb15-570"><a href="#cb15-570" aria-hidden="true" tabindex="-1"></a>extract the conditional independencies: $P(X_1, \dots, X_n) = \prod_{i = 1}^n P(X_i \mid \text{Pa}(X_i))$ where $\text{Pa}(X)$ are the parents of $X$.</span>
<span id="cb15-571"><a href="#cb15-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-572"><a href="#cb15-572" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb15-573"><a href="#cb15-573" aria-hidden="true" tabindex="-1"></a>p(\mu \mid \mathcal{D}, \boldsymbol{\theta}, \sigma^2, \tau^2) &amp;= \frac{p(\mu, \mathcal{D}, \boldsymbol{\theta}, \sigma^2, \tau^2)}{\int p(\mu, \mathcal{D}, \boldsymbol{\theta}, \sigma^2, \tau^2) \; d\mu} <span class="sc">\\</span></span>
<span id="cb15-574"><a href="#cb15-574" aria-hidden="true" tabindex="-1"></a>&amp;= \frac{p(\mu) p(\tau^2) p(\sigma^2) p(\mathcal{D} \mid \boldsymbol{\theta}, \sigma^2) p(\boldsymbol{\theta} \mid \mu, \tau^2) } {\int p(\mu) p(\tau^2) p(\sigma^2) p(\mathcal{D} \mid \boldsymbol{\theta}, \sigma^2) p(\boldsymbol{\theta} \mid \mu, \tau^2)\; d\mu } &amp; \text{Factorization} <span class="sc">\\</span></span>
<span id="cb15-575"><a href="#cb15-575" aria-hidden="true" tabindex="-1"></a>&amp;= \frac{p(\mu) p(\tau^2) p(\sigma^2) p(\mathcal{D} \mid \boldsymbol{\theta}, \sigma^2) p(\boldsymbol{\theta} \mid \mu, \tau^2) } { p(\tau^2) p(\sigma^2) p(\mathcal{D} \mid \boldsymbol{\theta}, \sigma^2) \int p(\mu) p(\boldsymbol{\theta} \mid \mu, \tau^2)\; d\mu } &amp; \text{Constants outside} <span class="sc">\\</span></span>
<span id="cb15-576"><a href="#cb15-576" aria-hidden="true" tabindex="-1"></a>&amp;= \frac{p(\mu) p(\boldsymbol{\theta} \mid \mu, \tau^2) } { \int p(\mu) p(\boldsymbol{\theta} \mid \mu, \tau^2)\; d\mu } &amp; <span class="sc">\\</span></span>
<span id="cb15-577"><a href="#cb15-577" aria-hidden="true" tabindex="-1"></a>&amp;= p(\mu \mid \boldsymbol{\theta}, \tau^2) &amp; \text{Bayes' rule}</span>
<span id="cb15-578"><a href="#cb15-578" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb15-579"><a href="#cb15-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-580"><a href="#cb15-580" aria-hidden="true" tabindex="-1"></a>This means that $\mu$ does not depend on the data (or $\sigma^2$) once</span>
<span id="cb15-581"><a href="#cb15-581" aria-hidden="true" tabindex="-1"></a>$\theta_1, \dots, \theta_m$ are known; another example of conditional</span>
<span id="cb15-582"><a href="#cb15-582" aria-hidden="true" tabindex="-1"></a>independence induced by the Bayes network.</span>
<span id="cb15-583"><a href="#cb15-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-584"><a href="#cb15-584" aria-hidden="true" tabindex="-1"></a><span class="fu">## 8.3</span></span>
<span id="cb15-585"><a href="#cb15-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-586"><a href="#cb15-586" aria-hidden="true" tabindex="-1"></a><span class="fu">### a</span></span>
<span id="cb15-587"><a href="#cb15-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-590"><a href="#cb15-590" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb15-591"><a href="#cb15-591" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data</span></span>
<span id="cb15-592"><a href="#cb15-592" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb15-593"><a href="#cb15-593" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb15-594"><a href="#cb15-594" aria-hidden="true" tabindex="-1"></a>schools.list <span class="ot">=</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>, <span class="cf">function</span>(i) {</span>
<span id="cb15-595"><a href="#cb15-595" aria-hidden="true" tabindex="-1"></a>  s.tbl <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">'Exercises/school'</span>, i, <span class="st">'.dat'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-596"><a href="#cb15-596" aria-hidden="true" tabindex="-1"></a>    read.table</span>
<span id="cb15-597"><a href="#cb15-597" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-598"><a href="#cb15-598" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb15-599"><a href="#cb15-599" aria-hidden="true" tabindex="-1"></a>    <span class="at">school =</span> i,</span>
<span id="cb15-600"><a href="#cb15-600" aria-hidden="true" tabindex="-1"></a>    <span class="at">hours =</span> s.tbl[, <span class="dv">1</span>] <span class="sc">%&gt;%</span> as.numeric</span>
<span id="cb15-601"><a href="#cb15-601" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb15-602"><a href="#cb15-602" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb15-603"><a href="#cb15-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-604"><a href="#cb15-604" aria-hidden="true" tabindex="-1"></a>schools.raw <span class="ot">=</span> <span class="fu">do.call</span>(rbind, schools.list)</span>
<span id="cb15-605"><a href="#cb15-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-606"><a href="#cb15-606" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">=</span> schools.raw</span>
<span id="cb15-607"><a href="#cb15-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-608"><a href="#cb15-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-609"><a href="#cb15-609" aria-hidden="true" tabindex="-1"></a><span class="co"># Prior</span></span>
<span id="cb15-610"><a href="#cb15-610" aria-hidden="true" tabindex="-1"></a>mu0 <span class="ot">=</span> <span class="dv">7</span></span>
<span id="cb15-611"><a href="#cb15-611" aria-hidden="true" tabindex="-1"></a>g20 <span class="ot">=</span> <span class="dv">5</span></span>
<span id="cb15-612"><a href="#cb15-612" aria-hidden="true" tabindex="-1"></a>t20 <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb15-613"><a href="#cb15-613" aria-hidden="true" tabindex="-1"></a>eta0 <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb15-614"><a href="#cb15-614" aria-hidden="true" tabindex="-1"></a>s20 <span class="ot">=</span> <span class="dv">15</span></span>
<span id="cb15-615"><a href="#cb15-615" aria-hidden="true" tabindex="-1"></a>nu0 <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb15-616"><a href="#cb15-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-617"><a href="#cb15-617" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of schools. Y[, 1] are school ids</span></span>
<span id="cb15-618"><a href="#cb15-618" aria-hidden="true" tabindex="-1"></a>m <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(Y[, <span class="dv">1</span>]))</span>
<span id="cb15-619"><a href="#cb15-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-620"><a href="#cb15-620" aria-hidden="true" tabindex="-1"></a><span class="co"># Starting values - use sample mean and variance</span></span>
<span id="cb15-621"><a href="#cb15-621" aria-hidden="true" tabindex="-1"></a>n <span class="ot">=</span> sv <span class="ot">=</span> ybar <span class="ot">=</span> <span class="fu">rep</span>(<span class="cn">NA</span>, m)</span>
<span id="cb15-622"><a href="#cb15-622" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>m) {</span>
<span id="cb15-623"><a href="#cb15-623" aria-hidden="true" tabindex="-1"></a>  Y_j <span class="ot">=</span> Y[Y[, <span class="dv">1</span>] <span class="sc">==</span> j, <span class="dv">2</span>]</span>
<span id="cb15-624"><a href="#cb15-624" aria-hidden="true" tabindex="-1"></a>  ybar[j] <span class="ot">=</span> <span class="fu">mean</span>(Y_j)</span>
<span id="cb15-625"><a href="#cb15-625" aria-hidden="true" tabindex="-1"></a>  sv[j] <span class="ot">=</span> <span class="fu">var</span>(Y_j)</span>
<span id="cb15-626"><a href="#cb15-626" aria-hidden="true" tabindex="-1"></a>  n[j] <span class="ot">=</span> <span class="fu">length</span>(Y_j)</span>
<span id="cb15-627"><a href="#cb15-627" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-628"><a href="#cb15-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-629"><a href="#cb15-629" aria-hidden="true" tabindex="-1"></a><span class="co"># Let initial theta estimates be the sample means</span></span>
<span id="cb15-630"><a href="#cb15-630" aria-hidden="true" tabindex="-1"></a><span class="co"># Similarly, let initial values of sigma2, mu, and tau2 be "sample mean and</span></span>
<span id="cb15-631"><a href="#cb15-631" aria-hidden="true" tabindex="-1"></a><span class="co"># variance"</span></span>
<span id="cb15-632"><a href="#cb15-632" aria-hidden="true" tabindex="-1"></a>theta <span class="ot">=</span> ybar</span>
<span id="cb15-633"><a href="#cb15-633" aria-hidden="true" tabindex="-1"></a>sigma2 <span class="ot">=</span> <span class="fu">mean</span>(sv)</span>
<span id="cb15-634"><a href="#cb15-634" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">=</span> <span class="fu">mean</span>(theta)</span>
<span id="cb15-635"><a href="#cb15-635" aria-hidden="true" tabindex="-1"></a>tau2 <span class="ot">=</span> <span class="fu">var</span>(theta)</span>
<span id="cb15-636"><a href="#cb15-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-637"><a href="#cb15-637" aria-hidden="true" tabindex="-1"></a><span class="co"># MCMC</span></span>
<span id="cb15-638"><a href="#cb15-638" aria-hidden="true" tabindex="-1"></a>S <span class="ot">=</span> <span class="dv">1500</span></span>
<span id="cb15-639"><a href="#cb15-639" aria-hidden="true" tabindex="-1"></a>THETA <span class="ot">=</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> S, <span class="at">ncol =</span> m)</span>
<span id="cb15-640"><a href="#cb15-640" aria-hidden="true" tabindex="-1"></a><span class="co"># Storing sigma, mu, theta together</span></span>
<span id="cb15-641"><a href="#cb15-641" aria-hidden="true" tabindex="-1"></a>SMT <span class="ot">=</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> S, <span class="at">ncol =</span> <span class="dv">3</span>)</span>
<span id="cb15-642"><a href="#cb15-642" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(SMT) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">'sigma2'</span>, <span class="st">'mu'</span>, <span class="st">'tau2'</span>)</span>
<span id="cb15-643"><a href="#cb15-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-644"><a href="#cb15-644" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (s <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>S) {</span>
<span id="cb15-645"><a href="#cb15-645" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sample thetas</span></span>
<span id="cb15-646"><a href="#cb15-646" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>m) {</span>
<span id="cb15-647"><a href="#cb15-647" aria-hidden="true" tabindex="-1"></a>    vtheta <span class="ot">=</span> <span class="dv">1</span> <span class="sc">/</span> (n[j] <span class="sc">/</span> sigma2 <span class="sc">+</span> <span class="dv">1</span> <span class="sc">/</span> tau2)</span>
<span id="cb15-648"><a href="#cb15-648" aria-hidden="true" tabindex="-1"></a>    etheta <span class="ot">=</span> vtheta <span class="sc">*</span> (ybar[j] <span class="sc">*</span> n[j] <span class="sc">/</span> sigma2 <span class="sc">+</span> mu <span class="sc">/</span> tau2)</span>
<span id="cb15-649"><a href="#cb15-649" aria-hidden="true" tabindex="-1"></a>    theta[j] <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, etheta, <span class="fu">sqrt</span>(vtheta))</span>
<span id="cb15-650"><a href="#cb15-650" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-651"><a href="#cb15-651" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-652"><a href="#cb15-652" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sample sigma2</span></span>
<span id="cb15-653"><a href="#cb15-653" aria-hidden="true" tabindex="-1"></a>  nun <span class="ot">=</span> nu0 <span class="sc">+</span> <span class="fu">sum</span>(n) <span class="co"># </span><span class="al">TODO</span><span class="co">: Could cache this</span></span>
<span id="cb15-654"><a href="#cb15-654" aria-hidden="true" tabindex="-1"></a>  ss <span class="ot">=</span> nu0 <span class="sc">*</span> s20</span>
<span id="cb15-655"><a href="#cb15-655" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Pool variance</span></span>
<span id="cb15-656"><a href="#cb15-656" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>m) {</span>
<span id="cb15-657"><a href="#cb15-657" aria-hidden="true" tabindex="-1"></a>    ss <span class="ot">=</span> ss <span class="sc">+</span> <span class="fu">sum</span>((Y[Y[, <span class="dv">1</span>] <span class="sc">==</span> j, <span class="dv">2</span>] <span class="sc">-</span> theta[j])<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb15-658"><a href="#cb15-658" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-659"><a href="#cb15-659" aria-hidden="true" tabindex="-1"></a>  sigma2 <span class="ot">=</span> <span class="dv">1</span> <span class="sc">/</span> <span class="fu">rgamma</span>(<span class="dv">1</span>, nun <span class="sc">/</span> <span class="dv">2</span>, ss <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb15-660"><a href="#cb15-660" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-661"><a href="#cb15-661" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sample mu</span></span>
<span id="cb15-662"><a href="#cb15-662" aria-hidden="true" tabindex="-1"></a>  vmu <span class="ot">=</span> <span class="dv">1</span> <span class="sc">/</span> (m <span class="sc">/</span> tau2 <span class="sc">+</span> <span class="dv">1</span> <span class="sc">/</span>g20)</span>
<span id="cb15-663"><a href="#cb15-663" aria-hidden="true" tabindex="-1"></a>  emu <span class="ot">=</span> vmu <span class="sc">*</span> (m <span class="sc">*</span> <span class="fu">mean</span>(theta) <span class="sc">/</span> tau2 <span class="sc">+</span> mu0 <span class="sc">/</span> g20)</span>
<span id="cb15-664"><a href="#cb15-664" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, emu, <span class="fu">sqrt</span>(vmu))</span>
<span id="cb15-665"><a href="#cb15-665" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-666"><a href="#cb15-666" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sample tau2</span></span>
<span id="cb15-667"><a href="#cb15-667" aria-hidden="true" tabindex="-1"></a>  etam <span class="ot">=</span> eta0 <span class="sc">+</span> m</span>
<span id="cb15-668"><a href="#cb15-668" aria-hidden="true" tabindex="-1"></a>  ss <span class="ot">=</span> eta0 <span class="sc">*</span> t20 <span class="sc">+</span> <span class="fu">sum</span>((theta <span class="sc">-</span> mu)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb15-669"><a href="#cb15-669" aria-hidden="true" tabindex="-1"></a>  tau2 <span class="ot">=</span> <span class="dv">1</span> <span class="sc">/</span> <span class="fu">rgamma</span>(<span class="dv">1</span>, etam <span class="sc">/</span> <span class="dv">2</span>, ss <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb15-670"><a href="#cb15-670" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-671"><a href="#cb15-671" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Store params</span></span>
<span id="cb15-672"><a href="#cb15-672" aria-hidden="true" tabindex="-1"></a>  THETA[s, ] <span class="ot">=</span> theta</span>
<span id="cb15-673"><a href="#cb15-673" aria-hidden="true" tabindex="-1"></a>  SMT[s, ] <span class="ot">=</span> <span class="fu">c</span>(sigma2, mu, tau2)</span>
<span id="cb15-674"><a href="#cb15-674" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-675"><a href="#cb15-675" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-676"><a href="#cb15-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-677"><a href="#cb15-677" aria-hidden="true" tabindex="-1"></a>Assess convergence with diagnostic boxplots:</span>
<span id="cb15-678"><a href="#cb15-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-679"><a href="#cb15-679" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE}</span></span>
<span id="cb15-680"><a href="#cb15-680" aria-hidden="true" tabindex="-1"></a>smt.df <span class="ot">=</span> <span class="fu">data.frame</span>(SMT)</span>
<span id="cb15-681"><a href="#cb15-681" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(smt.df) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">'sigma2'</span>, <span class="st">'mu'</span>, <span class="st">'tau2'</span>)</span>
<span id="cb15-682"><a href="#cb15-682" aria-hidden="true" tabindex="-1"></a>smt.df<span class="sc">$</span>s <span class="ot">=</span> <span class="dv">1</span><span class="sc">:</span>S</span>
<span id="cb15-683"><a href="#cb15-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-684"><a href="#cb15-684" aria-hidden="true" tabindex="-1"></a>cut_size <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb15-685"><a href="#cb15-685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-686"><a href="#cb15-686" aria-hidden="true" tabindex="-1"></a>smt.df <span class="ot">=</span> smt.df <span class="sc">%&gt;%</span></span>
<span id="cb15-687"><a href="#cb15-687" aria-hidden="true" tabindex="-1"></a>  tbl_df <span class="sc">%&gt;%</span></span>
<span id="cb15-688"><a href="#cb15-688" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">scut =</span> <span class="fu">cut</span>(s, <span class="at">breaks =</span> cut_size)) <span class="sc">%&gt;%</span></span>
<span id="cb15-689"><a href="#cb15-689" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(<span class="st">'variable'</span>, <span class="st">'value'</span>, sigma2<span class="sc">:</span>tau2)</span>
<span id="cb15-690"><a href="#cb15-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-691"><a href="#cb15-691" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(smt.df, <span class="fu">aes</span>(<span class="at">x =</span> scut, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb15-692"><a href="#cb15-692" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> variable, <span class="at">scales =</span> <span class="st">'free_y'</span>) <span class="sc">+</span></span>
<span id="cb15-693"><a href="#cb15-693" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb15-694"><a href="#cb15-694" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb15-695"><a href="#cb15-695" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">'Samples'</span>)</span>
<span id="cb15-696"><a href="#cb15-696" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-697"><a href="#cb15-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-698"><a href="#cb15-698" aria-hidden="true" tabindex="-1"></a>Evaluate effective sample size:</span>
<span id="cb15-699"><a href="#cb15-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-702"><a href="#cb15-702" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb15-703"><a href="#cb15-703" aria-hidden="true" tabindex="-1"></a><span class="co"># Tweak number of samples until all of the below are above 1000</span></span>
<span id="cb15-704"><a href="#cb15-704" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(coda)</span>
<span id="cb15-705"><a href="#cb15-705" aria-hidden="true" tabindex="-1"></a><span class="fu">effectiveSize</span>(SMT[, <span class="dv">1</span>])</span>
<span id="cb15-706"><a href="#cb15-706" aria-hidden="true" tabindex="-1"></a><span class="fu">effectiveSize</span>(SMT[, <span class="dv">2</span>])</span>
<span id="cb15-707"><a href="#cb15-707" aria-hidden="true" tabindex="-1"></a><span class="fu">effectiveSize</span>(SMT[, <span class="dv">3</span>])</span>
<span id="cb15-708"><a href="#cb15-708" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-709"><a href="#cb15-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-710"><a href="#cb15-710" aria-hidden="true" tabindex="-1"></a><span class="fu">### b</span></span>
<span id="cb15-711"><a href="#cb15-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-712"><a href="#cb15-712" aria-hidden="true" tabindex="-1"></a>Posterior means and confidence intervals</span>
<span id="cb15-713"><a href="#cb15-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-716"><a href="#cb15-716" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb15-717"><a href="#cb15-717" aria-hidden="true" tabindex="-1"></a><span class="fu">t</span>(<span class="fu">apply</span>(SMT, <span class="at">MARGIN =</span> <span class="dv">2</span>, <span class="at">FUN =</span> quantile, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span>)))</span>
<span id="cb15-718"><a href="#cb15-718" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-719"><a href="#cb15-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-720"><a href="#cb15-720" aria-hidden="true" tabindex="-1"></a>Comparing posterior to prior:</span>
<span id="cb15-723"><a href="#cb15-723" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb15-724"><a href="#cb15-724" aria-hidden="true" tabindex="-1"></a><span class="co"># For dinvgamma</span></span>
<span id="cb15-725"><a href="#cb15-725" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MCMCpack)</span>
<span id="cb15-726"><a href="#cb15-726" aria-hidden="true" tabindex="-1"></a>sigma2_prior <span class="ot">=</span> <span class="fu">data.frame</span>(</span>
<span id="cb15-727"><a href="#cb15-727" aria-hidden="true" tabindex="-1"></a>  <span class="at">value =</span> <span class="fu">seq</span>(<span class="dv">10</span>, <span class="fl">22.5</span>, <span class="at">by =</span> <span class="fl">0.1</span>),</span>
<span id="cb15-728"><a href="#cb15-728" aria-hidden="true" tabindex="-1"></a>  <span class="at">density =</span> <span class="fu">dinvgamma</span>(<span class="fu">seq</span>(<span class="dv">10</span>, <span class="fl">22.5</span>, <span class="at">by =</span> <span class="fl">0.1</span>), nu0 <span class="sc">/</span> <span class="dv">2</span>, nu0 <span class="sc">*</span> s20 <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb15-729"><a href="#cb15-729" aria-hidden="true" tabindex="-1"></a>  <span class="at">variable =</span> <span class="st">'sigma2'</span></span>
<span id="cb15-730"><a href="#cb15-730" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-731"><a href="#cb15-731" aria-hidden="true" tabindex="-1"></a>tau2_prior <span class="ot">=</span> <span class="fu">data.frame</span>(</span>
<span id="cb15-732"><a href="#cb15-732" aria-hidden="true" tabindex="-1"></a>  <span class="at">value =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">30</span>, <span class="at">by =</span> <span class="fl">0.1</span>),</span>
<span id="cb15-733"><a href="#cb15-733" aria-hidden="true" tabindex="-1"></a>  <span class="at">density =</span> <span class="fu">dinvgamma</span>(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">30</span>, <span class="at">by =</span> <span class="fl">0.1</span>), eta0 <span class="sc">/</span> <span class="dv">2</span>, eta0 <span class="sc">*</span> t20 <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb15-734"><a href="#cb15-734" aria-hidden="true" tabindex="-1"></a>  <span class="at">variable =</span> <span class="st">'tau2'</span></span>
<span id="cb15-735"><a href="#cb15-735" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-736"><a href="#cb15-736" aria-hidden="true" tabindex="-1"></a>mu_prior <span class="ot">=</span> <span class="fu">data.frame</span>(</span>
<span id="cb15-737"><a href="#cb15-737" aria-hidden="true" tabindex="-1"></a>  <span class="at">value =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">12</span>, <span class="at">by =</span> <span class="fl">0.1</span>),</span>
<span id="cb15-738"><a href="#cb15-738" aria-hidden="true" tabindex="-1"></a>  <span class="at">density =</span> <span class="fu">dnorm</span>(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">12</span>, <span class="at">by =</span> <span class="fl">0.1</span>), mu0, <span class="fu">sqrt</span>(g20)),</span>
<span id="cb15-739"><a href="#cb15-739" aria-hidden="true" tabindex="-1"></a>  <span class="at">variable =</span> <span class="st">'mu'</span></span>
<span id="cb15-740"><a href="#cb15-740" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-741"><a href="#cb15-741" aria-hidden="true" tabindex="-1"></a>priors <span class="ot">=</span> <span class="fu">rbind</span>(sigma2_prior, tau2_prior, mu_prior)</span>
<span id="cb15-742"><a href="#cb15-742" aria-hidden="true" tabindex="-1"></a>priors<span class="sc">$</span>dist <span class="ot">=</span> <span class="st">'prior'</span></span>
<span id="cb15-743"><a href="#cb15-743" aria-hidden="true" tabindex="-1"></a>smt.df<span class="sc">$</span>dist <span class="ot">=</span> <span class="st">'posterior'</span></span>
<span id="cb15-744"><a href="#cb15-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-745"><a href="#cb15-745" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(priors, <span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">y =</span> density, <span class="at">color =</span> dist)) <span class="sc">+</span></span>
<span id="cb15-746"><a href="#cb15-746" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb15-747"><a href="#cb15-747" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">data =</span> smt.df, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">y =</span> ..density..)) <span class="sc">+</span></span>
<span id="cb15-748"><a href="#cb15-748" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> variable, <span class="at">scales =</span> <span class="st">'free'</span>)</span>
<span id="cb15-749"><a href="#cb15-749" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-750"><a href="#cb15-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-751"><a href="#cb15-751" aria-hidden="true" tabindex="-1"></a>Our prior estimates for $\mu$ and $\tau^2$ were fairly estimate, but our </span>
<span id="cb15-752"><a href="#cb15-752" aria-hidden="true" tabindex="-1"></a>estimate for $\sigma^2$ was very far off. After this analysis, we have estimates</span>
<span id="cb15-753"><a href="#cb15-753" aria-hidden="true" tabindex="-1"></a>for $\mu$, the average amount of hours of schoolwork spent at a typical school, </span>
<span id="cb15-754"><a href="#cb15-754" aria-hidden="true" tabindex="-1"></a>$\tau^2$, the variability between schools in the average hours of schoolwork, </span>
<span id="cb15-755"><a href="#cb15-755" aria-hidden="true" tabindex="-1"></a>and $\sigma^2$, the variability among students' hours in each school.</span>
<span id="cb15-756"><a href="#cb15-756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-757"><a href="#cb15-757" aria-hidden="true" tabindex="-1"></a><span class="fu">### c</span></span>
<span id="cb15-760"><a href="#cb15-760" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb15-761"><a href="#cb15-761" aria-hidden="true" tabindex="-1"></a>t20_prior <span class="ot">=</span> (<span class="dv">1</span> <span class="sc">/</span> <span class="fu">rgamma</span>(<span class="fl">1e6</span>, eta0 <span class="sc">/</span> <span class="dv">2</span>, eta0 <span class="sc">*</span> t20 <span class="sc">/</span> <span class="dv">2</span>))</span>
<span id="cb15-762"><a href="#cb15-762" aria-hidden="true" tabindex="-1"></a>s20_prior <span class="ot">=</span> (<span class="dv">1</span> <span class="sc">/</span> <span class="fu">rgamma</span>(<span class="fl">1e6</span>, nu0 <span class="sc">/</span> <span class="dv">2</span>, nu0 <span class="sc">*</span> s20 <span class="sc">/</span> <span class="dv">2</span>))</span>
<span id="cb15-763"><a href="#cb15-763" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-764"><a href="#cb15-764" aria-hidden="true" tabindex="-1"></a>R_prior <span class="ot">=</span> <span class="fu">data.frame</span>(</span>
<span id="cb15-765"><a href="#cb15-765" aria-hidden="true" tabindex="-1"></a>  <span class="at">value =</span> (t20_prior) <span class="sc">/</span> (t20_prior <span class="sc">+</span> s20_prior),</span>
<span id="cb15-766"><a href="#cb15-766" aria-hidden="true" tabindex="-1"></a>  <span class="at">dist =</span> <span class="st">'prior'</span></span>
<span id="cb15-767"><a href="#cb15-767" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-768"><a href="#cb15-768" aria-hidden="true" tabindex="-1"></a>R_post <span class="ot">=</span> <span class="fu">data.frame</span>(</span>
<span id="cb15-769"><a href="#cb15-769" aria-hidden="true" tabindex="-1"></a>  <span class="at">value =</span> SMT[, <span class="st">'tau2'</span>] <span class="sc">/</span> (SMT[, <span class="st">'tau2'</span>] <span class="sc">+</span> SMT[, <span class="st">'sigma2'</span>]),</span>
<span id="cb15-770"><a href="#cb15-770" aria-hidden="true" tabindex="-1"></a>  <span class="at">dist =</span> <span class="st">'posterior'</span></span>
<span id="cb15-771"><a href="#cb15-771" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-772"><a href="#cb15-772" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-773"><a href="#cb15-773" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(R_prior, <span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">y =</span> ..density.., <span class="at">color =</span> dist)) <span class="sc">+</span></span>
<span id="cb15-774"><a href="#cb15-774" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">data =</span> R_prior) <span class="sc">+</span></span>
<span id="cb15-775"><a href="#cb15-775" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">data =</span> R_post)</span>
<span id="cb15-776"><a href="#cb15-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-777"><a href="#cb15-777" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(R_post<span class="sc">$</span>value)</span>
<span id="cb15-778"><a href="#cb15-778" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-779"><a href="#cb15-779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-780"><a href="#cb15-780" aria-hidden="true" tabindex="-1"></a>$R$ measures how much of the total variance in our data is between-group. Our</span>
<span id="cb15-781"><a href="#cb15-781" aria-hidden="true" tabindex="-1"></a>prior didn't contain much information about this quantity, but after inference,</span>
<span id="cb15-782"><a href="#cb15-782" aria-hidden="true" tabindex="-1"></a>we expect that around 25\% of our variance comes from between group variance</span>
<span id="cb15-783"><a href="#cb15-783" aria-hidden="true" tabindex="-1"></a>($\tau^2$).</span>
<span id="cb15-784"><a href="#cb15-784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-785"><a href="#cb15-785" aria-hidden="true" tabindex="-1"></a><span class="fu">### d</span></span>
<span id="cb15-786"><a href="#cb15-786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-789"><a href="#cb15-789" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb15-790"><a href="#cb15-790" aria-hidden="true" tabindex="-1"></a>theta7_lt_6 <span class="ot">=</span> THETA[, <span class="dv">7</span>] <span class="sc">&lt;</span> THETA[, <span class="dv">6</span>]</span>
<span id="cb15-791"><a href="#cb15-791" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(theta7_lt_6)</span>
<span id="cb15-792"><a href="#cb15-792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-793"><a href="#cb15-793" aria-hidden="true" tabindex="-1"></a>theta7_smallest <span class="ot">=</span> (THETA[, <span class="dv">7</span>] <span class="sc">&lt;</span> THETA[, <span class="sc">-</span><span class="dv">7</span>]) <span class="sc">%&gt;%</span></span>
<span id="cb15-794"><a href="#cb15-794" aria-hidden="true" tabindex="-1"></a>  <span class="fu">apply</span>(<span class="at">MARGIN =</span> <span class="dv">1</span>, <span class="at">FUN =</span> all)</span>
<span id="cb15-795"><a href="#cb15-795" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-796"><a href="#cb15-796" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(theta7_smallest)</span>
<span id="cb15-797"><a href="#cb15-797" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-798"><a href="#cb15-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-799"><a href="#cb15-799" aria-hidden="true" tabindex="-1"></a><span class="fu">### e</span></span>
<span id="cb15-800"><a href="#cb15-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-801"><a href="#cb15-801" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-804"><a href="#cb15-804" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb15-805"><a href="#cb15-805" aria-hidden="true" tabindex="-1"></a>relationship <span class="ot">=</span> <span class="fu">data.frame</span>(</span>
<span id="cb15-806"><a href="#cb15-806" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_average =</span> ybar,</span>
<span id="cb15-807"><a href="#cb15-807" aria-hidden="true" tabindex="-1"></a>  <span class="at">post_exp =</span> <span class="fu">colMeans</span>(THETA),</span>
<span id="cb15-808"><a href="#cb15-808" aria-hidden="true" tabindex="-1"></a>  <span class="at">school =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(ybar)</span>
<span id="cb15-809"><a href="#cb15-809" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-810"><a href="#cb15-810" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(relationship, <span class="fu">aes</span>(<span class="at">x =</span> sample_average, <span class="at">y =</span> post_exp, <span class="at">label =</span> school)) <span class="sc">+</span></span>
<span id="cb15-811"><a href="#cb15-811" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>() <span class="sc">+</span></span>
<span id="cb15-812"><a href="#cb15-812" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb15-813"><a href="#cb15-813" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">mean</span>(schools.raw[, <span class="st">'hours'</span>]), <span class="at">lty =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb15-814"><a href="#cb15-814" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">'text'</span>, <span class="at">x =</span> <span class="dv">10</span>, <span class="at">y =</span> <span class="fl">7.9</span>, <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Pooled sample mean "</span>, <span class="fu">round</span>(<span class="fu">mean</span>(schools.raw[, <span class="st">'hours'</span>]), <span class="dv">2</span>))) <span class="sc">+</span></span>
<span id="cb15-815"><a href="#cb15-815" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">mean</span>(SMT[, <span class="st">'mu'</span>]), <span class="at">color =</span> <span class="st">'red'</span>) <span class="sc">+</span></span>
<span id="cb15-816"><a href="#cb15-816" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">'text'</span>, <span class="at">x =</span> <span class="dv">10</span>, <span class="at">y =</span> <span class="fl">7.4</span>, <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Posterior exp. mu "</span>, <span class="fu">round</span>(<span class="fu">mean</span>(SMT[, <span class="st">'mu'</span>]), <span class="dv">2</span>)), <span class="at">color =</span> <span class="st">'red'</span>)</span>
<span id="cb15-817"><a href="#cb15-817" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-818"><a href="#cb15-818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-819"><a href="#cb15-819" aria-hidden="true" tabindex="-1"></a>There is a quite tight correspondence between the sample average and the</span>
<span id="cb15-820"><a href="#cb15-820" aria-hidden="true" tabindex="-1"></a>posterior expectation, although mild shrinkage can be observed with schools with</span>
<span id="cb15-821"><a href="#cb15-821" aria-hidden="true" tabindex="-1"></a>very high and low sample averages being pulled towards the mean.</span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>© Jesse Mu</p>
<div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/d-morrison/hoff-bayesian-statistics/edit/main/8.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/d-morrison/hoff-bayesian-statistics/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li><li><a href="https://github.com/d-morrison/hoff-bayesian-statistics/blob/main/8.qmd" class="toc-action"><i class="bi empty"></i>View source</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer><script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>


</body></html>